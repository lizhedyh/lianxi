const should = require('should/as-function');

const {
  _isJson,
  _uniqfyState,
  _parseThunderStateList,
  _genWarmupChunkPairs,
  _chunkPairsToUrl,
  _limitedPromiseAll,
} = require('./index');

describe('index', function () {

  describe('_isJson', function () {

    it('should return true if text is valid JSON', function () {
      const result = _isJson(`{"a": 1}`);
      should(result).be.exactly(true);
    });
    
    it('should return false if text is invalid JSON', function () {
      const result = _isJson(`{a: 1}`);
      should(result).be.exactly(false);
    });

  });

  describe('_uniqfyState', function () {

    it('should be able to remove duplicated states', function () {
      const stateList = [
        {
          chunksMap: {},
          StarkOptions: {},
          outputOptions: {},
          assetsByChunkName: {},
        },
        {
          chunksMap: {},
          StarkOptions: {},
          outputOptions: {},
          assetsByChunkName: {},
        },
        {
          chunksMap: {
             "app": {
               "type": "chunk",
               "hash": "275f06eea2c9faa0576a"
             },
             "vendor": {
               "type": "chunk",
               "hash": "7ae81b5caa39ffbc8bb9"
             }
          },
          StarkOptions: {
            "projectName": "asdasdasd",
            "dist": "resource/vue"
          },
          outputOptions: {
            "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
            "filename": "js/[name].[chunkhash].js",
            "chunkFilename": "js/[name].[chunkhash].js",
            "library": "",
            "hotUpdateFunction": "webpackHotUpdate",
            "jsonpFunction": "webpackJsonp",
            "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
          },
        },
        {
          chunksMap: {
             "app": {
               "type": "chunk",
               "hash": "275f06eea2c9faa0576a"
             },
             "vendor": {
               "type": "chunk",
               "hash": "7ae81b5caa39ffbc8bb9"
             }
          },
          StarkOptions: {
            "projectName": "asdasdasd",
            "dist": "resource/vue"
          },
          outputOptions: {
            "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
            "filename": "js/[name].[chunkhash].js",
            "chunkFilename": "js/[name].[chunkhash].js",
            "library": "",
            "hotUpdateFunction": "webpackHotUpdate",
            "jsonpFunction": "webpackJsonp",
            "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
          },
        },
      ];
      should(_uniqfyState(stateList).length).be.exactly(2);
    });

  });

  describe('_parseThunderStateList', function () {

    it('should return a list which grouped by chunk', function () {
      const thunderStateList = [
        {
          chunksMap: {
            "app": {
              "type": "chunk",
              "hash": "275f06eea2c9faa0576a"
            },
            "vendor": {
              "type": "chunk",
              "hash": "7ae81b5caa39ffbc8bb9"
            }
          },
          StarkOptions: {
            "projectName": "asdasdasd",
            "dist": "resource/vue"
          },
          outputOptions: {
            "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
            "filename": "js/[name].[chunkhash].js",
            "chunkFilename": "js/[name].[chunkhash].js",
            "library": "",
            "hotUpdateFunction": "webpackHotUpdate",
            "jsonpFunction": "webpackJsonp",
            "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
          },
        },
        {
          chunksMap: {
            "app": {
              "type": "chunk",
              "hash": "1321231231231"
            },
            "vendor": {
              "type": "chunk",
              "hash": "7ae81b5caa39ffbc8bb9"
            }
          },
          StarkOptions: {
            "projectName": "asdasdasd",
            "dist": "resource/vue"
          },
          outputOptions: {
            "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
            "filename": "js/[name].[chunkhash].js",
            "chunkFilename": "js/[name].[chunkhash].js",
            "library": "",
            "hotUpdateFunction": "webpackHotUpdate",
            "jsonpFunction": "webpackJsonp",
            "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
          },
        },
      ];
      const result = _parseThunderStateList(thunderStateList);
      should(result).have.property('app');
      should(result).have.property('vendor');
      should(result.app.length).be.exactly(2);
      should(result.vendor.length).be.exactly(2);
    });

  });
  
  describe('_genWarmupChunkPairs', function () {

    it('should return a list which grouped by chunk', function () {
      const verticalChunkMap = {
        "app": [{
            "chunk": {
              "type": "chunk",
              "hash": "275f06eea2c9faa0576a"
            },
            "thunderState": {
              "chunksMap": {
                "app": {
                  "type": "chunk",
                  "hash": "275f06eea2c9faa0576a"
                },
                "vendor": {
                  "type": "chunk",
                  "hash": "7ae81b5caa39ffbc8bb9"
                }
              },
              "StarkOptions": {
                "projectName": "asdasdasd",
                "dist": "resource/vue"
              },
              "outputOptions": {
                "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
                "filename": "js/[name].[chunkhash].js",
                "chunkFilename": "js/[name].[chunkhash].js",
                "library": "",
                "hotUpdateFunction": "webpackHotUpdate",
                "jsonpFunction": "webpackJsonp",
                "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
              }
            }
          },
          {
            "chunk": {
              "type": "chunk",
              "hash": "1321231231231"
            },
            "thunderState": {
              "chunksMap": {
                "app": {
                  "type": "chunk",
                  "hash": "1321231231231"
                },
                "vendor": {
                  "type": "chunk",
                  "hash": "7ae81b5caa39ffbc8bb9"
                }
              },
              "StarkOptions": {
                "projectName": "asdasdasd",
                "dist": "resource/vue"
              },
              "outputOptions": {
                "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
                "filename": "js/[name].[chunkhash].js",
                "chunkFilename": "js/[name].[chunkhash].js",
                "library": "",
                "hotUpdateFunction": "webpackHotUpdate",
                "jsonpFunction": "webpackJsonp",
                "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
              }
            }
          }
        ],
        "vendor": [{
            "chunk": {
              "type": "chunk",
              "hash": "7ae81b5caa39ffbc8bb9"
            },
            "thunderState": {
              "chunksMap": {
                "app": {
                  "type": "chunk",
                  "hash": "275f06eea2c9faa0576a"
                },
                "vendor": {
                  "type": "chunk",
                  "hash": "7ae81b5caa39ffbc8bb9"
                }
              },
              "StarkOptions": {
                "projectName": "asdasdasd",
                "dist": "resource/vue"
              },
              "outputOptions": {
                "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
                "filename": "js/[name].[chunkhash].js",
                "chunkFilename": "js/[name].[chunkhash].js",
                "library": "",
                "hotUpdateFunction": "webpackHotUpdate",
                "jsonpFunction": "webpackJsonp",
                "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
              }
            }
          },
          {
            "chunk": {
              "type": "chunk",
              "hash": "7ae81b5caa39ffbc8bb9"
            },
            "thunderState": {
              "chunksMap": {
                "app": {
                  "type": "chunk",
                  "hash": "1321231231231"
                },
                "vendor": {
                  "type": "chunk",
                  "hash": "7ae81b5caa39ffbc8bb9"
                }
              },
              "StarkOptions": {
                "projectName": "asdasdasd",
                "dist": "resource/vue"
              },
              "outputOptions": {
                "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
                "filename": "js/[name].[chunkhash].js",
                "chunkFilename": "js/[name].[chunkhash].js",
                "library": "",
                "hotUpdateFunction": "webpackHotUpdate",
                "jsonpFunction": "webpackJsonp",
                "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
              }
            }
          }
        ]
      };
      const chunkPairs = _genWarmupChunkPairs(verticalChunkMap);
      should(chunkPairs.length).be.exactly(2);
      should(chunkPairs[0][0]).have.property('name');
      should(chunkPairs[0][0]).have.property('from');
      should(chunkPairs[0][0]).have.property('to');
    });

  });
  
  describe('_chunkPairsToUrl', function () {

    it('should return a list which grouped by chunk', function () {
      const chunkPairs = [
        [{
          "name": "app",
          "from": {
            "chunk": {
              "type": "chunk",
              "hash": "275f06eea2c9faa0576a"
            },
            "thunderState": {
              "chunksMap": {
                "app": {
                  "type": "chunk",
                  "hash": "275f06eea2c9faa0576a"
                },
                "vendor": {
                  "type": "chunk",
                  "hash": "7ae81b5caa39ffbc8bb9"
                }
              },
              "StarkOptions": {
                "projectName": "asdasdasd",
                "dist": "resource/vue"
              },
              "outputOptions": {
                "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
                "filename": "js/[name].[chunkhash].js",
                "chunkFilename": "js/[name].[chunkhash].js",
                "library": "",
                "hotUpdateFunction": "webpackHotUpdate",
                "jsonpFunction": "webpackJsonp",
                "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
              }
            }
          },
          "to": {
            "chunk": {
              "type": "chunk",
              "hash": "1321231231231"
            },
            "thunderState": {
              "chunksMap": {
                "app": {
                  "type": "chunk",
                  "hash": "1321231231231"
                },
                "vendor": {
                  "type": "chunk",
                  "hash": "7ae81b5caa39ffbc8bb9"
                }
              },
              "StarkOptions": {
                "projectName": "asdasdasd",
                "dist": "resource/vue"
              },
              "outputOptions": {
                "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
                "filename": "js/[name].[chunkhash].js",
                "chunkFilename": "js/[name].[chunkhash].js",
                "library": "",
                "hotUpdateFunction": "webpackHotUpdate",
                "jsonpFunction": "webpackJsonp",
                "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
              }
            }
          }
        }],
        [{
          "name": "vendor",
          "from": {
            "chunk": {
              "type": "chunk",
              "hash": "7ae81b5caa39ffbc8bb9"
            },
            "thunderState": {
              "chunksMap": {
                "app": {
                  "type": "chunk",
                  "hash": "275f06eea2c9faa0576a"
                },
                "vendor": {
                  "type": "chunk",
                  "hash": "7ae81b5caa39ffbc8bb9"
                }
              },
              "StarkOptions": {
                "projectName": "asdasdasd",
                "dist": "resource/vue"
              },
              "outputOptions": {
                "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
                "filename": "js/[name].[chunkhash].js",
                "chunkFilename": "js/[name].[chunkhash].js",
                "library": "",
                "hotUpdateFunction": "webpackHotUpdate",
                "jsonpFunction": "webpackJsonp",
                "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
              }
            }
          },
          "to": {
            "chunk": {
              "type": "chunk",
              "hash": "7ae81b5caa39ffbc8bb9"
            },
            "thunderState": {
              "chunksMap": {
                "app": {
                  "type": "chunk",
                  "hash": "1321231231231"
                },
                "vendor": {
                  "type": "chunk",
                  "hash": "7ae81b5caa39ffbc8bb9"
                }
              },
              "StarkOptions": {
                "projectName": "asdasdasd",
                "dist": "resource/vue"
              },
              "outputOptions": {
                "publicPath": "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:asdasdasd/",
                "filename": "js/[name].[chunkhash].js",
                "chunkFilename": "js/[name].[chunkhash].js",
                "library": "",
                "hotUpdateFunction": "webpackHotUpdate",
                "jsonpFunction": "webpackJsonp",
                "thunderFilename": "thunder.fcc94b3b17ed9db9f305.js"
              }
            }
          }
        }]
      ];
      const urlList = _chunkPairsToUrl(chunkPairs);
      should(urlList.length).be.exactly(2);
    });

  });

  describe('_limitedPromiseAll', function () {

    it('should limit concurrent count', async function () {
      let concurrentCount = 0;
      let burstConcurrentCount = 0;
      let times = 10;
      const MAX_CONCURRENT_COUNT = 2;
      await _limitedPromiseAll(() => {
        if (times < 1) {
          return null;
        }
        times--;
        concurrentCount++;
        if (concurrentCount > burstConcurrentCount) {
          burstConcurrentCount = concurrentCount;
        }
        return new Promise((resolve) => {
          setTimeout(() => {
            concurrentCount--;
            resolve();
          }, 50);
        });
      }, MAX_CONCURRENT_COUNT);

      should(burstConcurrentCount).be.exactly(MAX_CONCURRENT_COUNT);
    });

  });

});