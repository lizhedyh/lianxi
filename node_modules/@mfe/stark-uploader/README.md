## Stark Uploader

帮助用户上传资源至Stark平台，即使项目并未接入thunder，也可以使用。

## 安装

```
npm i --save @mfe/stark-uploader
```

## 1.0.0版的使用方法

注意，这里列举的方法是1.0.0版后的方法，1.0.0版以下的使用方法请参考下一章节。

从1.0.0开始，Stark平台同时支持托管静态内容和动态内容。

静态内容指的是，一次发布，后续不可更改的文件，比如大家平时使用的 JavaScript 和 CSS 文件，大部分都是这样的静态内容。这些内容在 Stark 托管后，实际会再由CDN进行托管，由于这类文件的缓存有效期较长，刷新这些文件的内容是比较困难的。因此一般静态资源的版本直接体现在URL当中，每个不同版本的资源，URL都不应该相同。

而动态内容指的是，发布后在URL不变的前提下，可以反复更新内容的文件。比如大家如果写纯静态网站，虽然静态资源是有版本号的，但首页则没有。因为首页一旦发布对外，URL不宜修改。因此，动态内容主要针对的就是这样的场景。另外，Service Worker文件的文件名有时也会在项目中固定下来，这种时候也可以使用动态托管。

### 静态文件托管

```shell
stark-uploader --appkey xxxxxx [--secretkey xxxxxx] --static "**/*.js **/*.css !**/*.map !**/*.html" /path/to/folder

```
[ ]内的内容为可选项，为项目的密钥，在项目列表中可查，一但使用便会验证此参数的正确性。

使用`--static`参数，可以指定多个“glob”，其组合起来的结果会用于筛选`/path/to/folder`中的文件。例如，

```shell
$ tree ./texture/upload-assets/

./texture/upload-assets/
├── service-worker.js
├── test-image.png
├── test-index.html
├── test-js.js
└── test-js.no.js

$ stark-uploader --appkey xxxxxx [--secretkey xxxxxx] --static "**/*.js **/*.css !service-worker.js !**/*.html" ./texture/upload-assets/

```

那么上述命令会上传：
```
./texture/upload-assets/test-image.png
./texture/upload-assets/test-js.js
./texture/upload-assets/test-js.no.js
```

有关glob的写法问题，可以参考： https://github.com/micromatch/micromatch

静态托管的内容可以在 http://stark.sankuai.com 上查看。

### 动态文件托管

```shell
stark-uploader --appkey xxxxxx --secretkey xxxxxx --dynamic "**/*.html service-worker.js" /path/to/folder
```

和静态托管的内容类似，使用`--dynamic`选项，可以筛出动态托管的文件。

`--static`和`--dynamic`可以同时使用，比如：

```shell
stark-uploader --appkey xxxxxx --secretkey xxxxxx --dynamic "**/*.html service-worker.js" --static "**/*.js **/*.css !service-worker.js !**/*.html" /path/to/folder
```
注意，上传动态文件时，secretkey作为项目密钥是必传参数，此参数在项目列表中可查。

目前动态文件的扩展类型被限定在`.html`、`.htm`和`.js`，如果有其他需求，可以和我们联系。

## 1.0.0版以下的使用方法

### 上传多个文件

```
stark-uploader --appkey xxxxxx /path/to/file /path/to/another/file
```

其中`appkey`的值需要在 http://stark.sankuai.com 上根据自己的项目得到。

### 上传整个文件夹

```
stark-uploader --appkey xxxxxx --dir-mode /path/to/dir
```

该文件夹为递归上传。某些文件会被默认的黑名单拦截，黑名单如下：

```javascript

[
  /\.git/,
  /thunder-state/,
  /service-worker/,
  /\.DS_Store/,
  /\.log$/,
  /\.map$/,
];

```

相对路径匹配如上正则表达式的文件即会被跳过。

例如，如果一个文件的完整路径是`/mnt/d/anc.jpg`，而上传的根路径是`/mnt/d`，而黑名单规则包含`/mnt/`，那么这个文件不会被列入黑名单，即这个文件会被上传。因为相对路径仅仅是`d/anc.jpg`，并不和正则匹配。

如果想要增加黑名单，可以使用参数`--blacklist`，其内容是一个blob字符串。如果有多个内容，可以用空格分开。例如：

```shell
stark-uploader --appkey xxxxxx --dir-mode --blacklist "*/dist/index.html */dist/main.*.js" /path/to/dir
```

这样会过滤掉`/path/to/dir/dist/index.html`、`/path/to/dir/dist/main.alsiudhiashudl.html`以及`/path/to/dir/dist/main.2.html`等文件。

注意，需要上传的**文件夹始终应该是最后一个参数**。

## 其他

* 如果想知道哪些文件/目录会被上传，可以使用 `--dry` 参数来辅助判断，使用该参数不会真正进行上传，只会打印一些信息。
* 由于公司存在线上线下网络隔离，工具在dev、test环境机器上会因网络隔离而上传失败。如果将工具使用在上线脚本中，则应该在`pre-deploy`阶段使用。
* 如果想作为npm包编程使用，请与`liuyanghe02`联系。