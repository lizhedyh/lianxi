/*!
 * Thunder.js v2.3.7
 * (c) 2019-07-02 14:28:13 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Thunder=e()}(this,function(){"use strict";function t(t,e){window.fetch(t.url,{method:t.method,body:t.body}).then(function(t){return t.ok?t.text():e(t)}).then(function(t){e(null,t)}).catch(e)}function e(t,e){var n=new window.XMLHttpRequest;n.withCredentials=!1,n.open(t.method,t.url,!0),n.onreadystatechange=function(){4===n.readyState&&(200===n.status?(n.onreadystatechange=null,e(null,n.responseText)):e(new Error("ThunderError: content load failed")))},n.send(t.body)}function n(n,r){if(!P)return r(new Error("ThunderError: not in browser"));var o={method:"GET",data:null,url:"",body:void 0};return"string"==typeof n?o.url=n:u(o,n),o.method||(o.method=I.method),o.method=o.method.toUpperCase(),o.data&&(o.body=JSON.stringify(o.data)),K?t(o,r):e(o,r)}function r(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l;return new Promise(function(r,o){n(t,function(t,n){t?(e(t),o(t)):(e(null,n),r(n))})})}function o(t,e,n){var r=document.head||document.getElementsByTagName("head")[0],o=void 0;return"js"===e?(o=document.createElement("script"),o.type="text/javascript",o.charset="utf-8",o.text=t):(o=document.createElement("style"),o.type="text/css",o.charset="utf-8",o.textContent=t),n&&h(n).forEach(function(t){o.setAttribute(t,n[t])}),r.appendChild(o),"function"==typeof o.onload&&o.onload(),o}function i(t){var e=document.createElement("script");return e.type="text/javascript",e.charset="utf-8",e.async=!0,e.timeout=12e4,e.src=t,e}function a(t){var e=document.createElement("link");return e.rel="stylesheet",e.href=t,e.timeout=12e4,e.src=t,e}function s(t,e,n,r){function o(t){f(),u.onerror=u.onload=null,clearTimeout(d),r(t)}function s(){p(),u.onerror=u.onload=null,clearTimeout(d),r(null,u)}var c=document.head||document.getElementsByTagName("head")[0],u=void 0;if("js"===e?(u=i(t),n&&h(n).forEach(function(t){u.setAttribute(t,n[t])})):"css"===e&&(u=a(t)),!u)return r(new Error("execModuleAsyncLoad: wrong type with "+e));var f=l,p=l;"function"==typeof u.onerror&&(f=u.onerror),"function"==typeof u.onload&&(p=u.onload),u.onerror=o,u.onload=s;var d=setTimeout(function(){o(new Error("execModuleAsyncLoad: timeout "+t))},12e4);return c.appendChild(u),u}function c(){if(L){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];var r=e[0],o=void 0;console[r]?(o=console[r],e.shift()):o=console.log,e.unshift("[Thunder]"),o.apply(console,e)}}function u(t,e){if(void 0===t||null===t)throw new TypeError("Cannot convert first argument to object");for(var n=Object(t),r=1;r<arguments.length;r++){var o=arguments[r];if(void 0!==o&&null!==o)for(var i=h(Object(o)),a=0,s=i.length;a<s;a++){var c=i[a],u=Object.getOwnPropertyDescriptor(o,c);void 0!==u&&u.enumerable&&(n[c]=o[c])}}return n}function h(t){if(!x&&Object.keys)return Object.keys(t);if(t!==Object(t))throw new TypeError("Object.keys called on a non-object");var e=[],n=void 0;for(n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.push(n);return e}function l(){}function f(t,e){for(var n,r,o=-1^e,i=0,a=t.length;i<a;)n=t.charCodeAt(i++),n<128?o=o>>>8^R[255&(o^n)]:n<2048?(o=o>>>8^R[255&(o^(192|n>>6&31))],o=o>>>8^R[255&(o^(128|63&n))]):n>=55296&&n<57344?(n=64+(1023&n),r=1023&t.charCodeAt(i++),o=o>>>8^R[255&(o^(240|n>>8&7))],o=o>>>8^R[255&(o^(128|n>>2&63))],o=o>>>8^R[255&(o^(128|r>>6&15|(3&n)<<4))],o=o>>>8^R[255&(o^(128|63&r))]):(o=o>>>8^R[255&(o^(224|n>>12&15))],o=o>>>8^R[255&(o^(128|n>>6&63))],o=o>>>8^R[255&(o^(128|63&n))]);return(-1^o)>>>0}function p(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9;return Math.floor(Math.random()*(e-t+1))+t}function d(){for(var t=16,e="";t--;)e+=""+p();return e}function v(){return z?performance.now():Date.now()}function m(){return Z?Math.floor(performance.now()):Date.now()}function y(t,e,n){this.message=t,this.statusCode=e,this.result=n||{}}function k(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=e.split("\t"),r=t,o=0,i=m(),a=0;a<n.length;a++){var s=n[a][0];if("="===s)o+=parseInt(n[a].slice(1),10);else if("-"===s){var c=parseInt(n[a].slice(1),10);r=r.slice(0,o)+r.slice(o+c)}else{if("+"!==s)throw new y("Broken patch found",rt.CLIENT_PATCH_ERROR);var u=decodeURI(n[a].slice(1));r=r.slice(0,o)+u+r.slice(o),o+=u.length}}return{content:r,fullLength:r.length,patchLength:e.length,recoverCost:m()-i}}function g(t,e){var n=JSON.parse(t),r=void 0;if(n.status===nt.FAILED)throw new y("Stark service down",n.code);if(n.status===nt.FULL&&(r={status:n.status,statusCode:n.code,content:n.content,fullLength:n.content.length,patchLength:n.content.length,checksum:n.newFileChecksum}),n.status===nt.PATCH){var o=k(e,n.content);r={status:n.status,statusCode:n.code,content:o.content,fullLength:o.fullLength,patchLength:o.patchLength,checksum:n.newFileChecksum}}return r}function _(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=r.address,i=r.projectName,a=o||tt;if(e&&e.hash){var s=e.filename,c=n.filename;return""+a+i+"?oldFilePath="+encodeURIComponent(s)+"&newFilePath="+encodeURIComponent(c)}}function w(t,e,n,r){if(!n.state.StarkOptions)return r.Promise.resolve();var o=n.state.StarkOptions,i=o.projectName,a=o.fallback,s=a||et.replace("PROJECT_NAME",i);return n.set({fallbackCDN:s}),new ot(t,e,n.state.StarkOptions,r).getDiff()}function b(t){t.prototype._updateAdapter=w}var C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},E=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},A=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),O=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},S=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},T=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},j=function(t){function e(t){return"[object Array]"===Object.prototype.toString.call(t)}function n(){for(var t=0;t<E.length;t++)E[t][0](E[t][1]);E=[],d=!1}function r(t,e){E.push([t,e]),d||(d=!0,b(n,0))}function o(t,e){function n(t){s(e,t)}function r(t){u(e,t)}try{t(n,r)}catch(t){r(t)}}function i(t){var e=t.owner,n=e.state_,r=e.data_,o=t[n],i=t.then;if("function"==typeof o){n=g;try{r=o(r)}catch(t){u(i,t)}}a(i,r)||(n===g&&s(i,r),n===_&&u(i,r))}function a(t,e){var n;try{if(t===e)throw new TypeError("A promises callback cannot return that same promise.");if(e&&("function"==typeof e||"object"===(void 0===e?"undefined":C(e)))){var r=e.then;if("function"==typeof r)return r.call(e,function(r){n||(n=!0,e!==r?s(t,r):c(t,r))},function(e){n||(n=!0,u(t,e))}),!0}}catch(e){return n||u(t,e),!0}return!1}function s(t,e){t!==e&&a(t,e)||c(t,e)}function c(t,e){t.state_===y&&(t.state_=k,t.data_=e,r(l,t))}function u(t,e){t.state_===y&&(t.state_=k,t.data_=e,r(f,t))}function h(t){var e=t.then_;t.then_=void 0;for(var n=0;n<e.length;n++)i(e[n])}function l(t){t.state_=g,h(t)}function f(t){t.state_=_,h(t)}function p(t){if("function"!=typeof t)throw new TypeError("Promise constructor takes a function argument");if(this instanceof p==!1)throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this.then_=[],o(t,this)}var d,v=t.Promise,m=v&&"resolve"in v&&"reject"in v&&"all"in v&&"race"in v&&function(){var t;return new v(function(e){t=e}),"function"==typeof t}(),y="pending",k="sealed",g="fulfilled",_="rejected",w=function(){},b="undefined"!=typeof setImmediate?setImmediate:setTimeout,E=[];return p.prototype={constructor:p,state_:y,then_:null,data_:void 0,then:function(t,e){var n={owner:this,then:new this.constructor(w),fulfilled:t,rejected:e};return this.state_===g||this.state_===_?r(i,n):this.then_.push(n),n.then},catch:function(t){return this.then(null,t)}},p.all=function(t){var n=this;if(!e(t))throw new TypeError("You must pass an array to Promise.all().");return new n(function(e,n){for(var r,o=[],i=0,a=0;a<t.length;a++)r=t[a],r&&"function"==typeof r.then?r.then(function(t){return i++,function(n){o[t]=n,--i||e(o)}}(a),n):o[a]=r;i||e(o)})},p.race=function(t){var n=this;if(!e(t))throw new TypeError("You must pass an array to Promise.race().");return new n(function(e,n){for(var r,o=0;o<t.length;o++)r=t[o],r&&"function"==typeof r.then?r.then(e,n):e(r)})},p.resolve=function(t){var e=this;return t&&"object"===(void 0===t?"undefined":C(t))&&t.constructor===e?t:new e(function(e){e(t)})},p.reject=function(t){return new this(function(e,n){n(t)})},m?v:p}("undefined"!=typeof window?window:"undefined"!=typeof global&&global||{}),P="undefined"!=typeof window,N=function(t){if(!t)return!1;try{var e="__LS_SUPPORT_TEST_KEY__";return t.setItem(e,e),t.removeItem(e,e),!0}catch(t){return!1}}(window.localStorage),L=P&&"DEBUG_THUNDER"in window&&window.DEBUG_THUNDER,K=P&&"fetch"in window,x=P&&"UNIT_TEST_THUNDER"in window&&window.UNIT_TEST_THUNDER,I={method:"GET",data:null,url:""},M={markOnce:l,mark:l,markEnd:l},R=function(){for(var t=0,e=new Array(256),n=0;256!==n;++n)t=n,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,e[n]=t;return"undefined"!=typeof Int32Array?new Int32Array(e):e}(),D=function(){function t(e,n,r){E(this,t),this.type="",this.name=e,this.state=n,this.options=r,this.store=r.store,this.logger=r.logger,this._updateAdapter=r.updateAdapter,this._content=""}return A(t,[{key:"load",value:function(){return this.getContent().then(l,function(t){console.error(t)})}},{key:"check",value:function(){if(void 0===this.state.checksum)return!0;this.logger.mark("check:"+this.cacheKey,{chunkName:this.cacheKey,channel:"lx",reason:"chunkChecksum",size:Math.floor(this._content.length/1024),originChecksum:this.state.checksum,reportCost:!0});var t=f(this._content),e=t===this.state.checksum;return this.logger.markEnd("check:"+this.cacheKey,{isMatch:e,currentChecksum:t}),e||(this.store.remove(this.cacheKey),!1)}},{key:"_request",value:function(){var t=this;return new Promise(function(e,n){r(t.link,function(r,o){if(r)return t.logger.markEnd("async:"+t.cacheKey,{reason:"updateFullFailure",reportCost:!0}),n(r);t._content=o,t.store.add({name:t.cacheKey,hash:t.hash,cacheAge:t.state.cacheAge||t.options.cacheAge,content:t._content,filename:t.filename}),t.logger.markEnd("async:"+t.cacheKey,{reason:"updateFullSuccess",reportCost:!0}),e(o)})})}},{key:"update",value:function(t){var e=this;return this._updateAdapter(this.name,{localChunk:t,remoteChunk:this.state}).then(function(t){return t&&t.content?(e._content=t.content,e.store.add({name:e.cacheKey,hash:e.hash,cacheAge:e.state.cacheAge||e.options.cacheAge,content:e._content,filename:e.filename}),e._content):e._request()},function(t){return console.error(t),e._request()})}},{key:"getContent",value:function(){var t=this;return this._content?Promise.resolve(this._content):(this.logger.markOnce("request:"+this.cacheKey,{chunkName:this.cacheKey,channel:"lx",reason:"request"}),this.logger.mark("async:"+this.cacheKey,{chunkName:this.cacheKey,channel:"lx",reportCost:!0}),this.store.get(this.cacheKey).then(function(e){if(!e)return t._request();var n=e.content,r=e.hash;return t.hash===r?(t.logger.markEnd("async:"+t.cacheKey,{reason:t.store.type,reportCost:!0}),t._content=n,Promise.resolve(t._content)):t.update(e)}))}},{key:"fallback",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s;return this.logger.mark("fallback:"+this.cacheKey,{chunkName:this.cacheKey,channel:"lx",reason:"fallbackStart"}),new Promise(function(n,r){e(t.fallbackLink,t.type,t.attrs,function(o){if(!o)return t.fallbackState="fallbackSuccessFrist",n();e(t.fallbackLink,t.type,t.attrs,function(e){if(!e)return t.fallbackState="fallbackSuccessSecond",n();t.fallbackState="fallbackFailure",r(e)})})})}},{key:"cacheKey",get:function(){return"<"+this.type+">:"+this.name}},{key:"hash",get:function(){return this.state.hash||this.filename||this.link}},{key:"link",get:function(){return this.state.link?this.state.link:this.options.config.publicPath+this.filename}},{key:"fallbackState",set:function(t){this.logger.markEnd("fallback:"+this.cacheKey,{chunkName:this.cacheKey,channel:"lx",reason:t})}},{key:"fallbackLink",get:function(){return this.state.link?this.state.link:(this.options.config.fallbackCDN||this.options.config.publicPath)+this.filename}},{key:"attrs",get:function(){return u({"thunder-cache-key":this.cacheKey,crossorigin:this.options.config.crossOriginLoading},this.options.attrs,this.state.attrs)}}]),t}(),U="js",F=function(t){function e(t,n,r){E(this,e);var o=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,r));return o.type=U,o}return S(e,t),A(e,[{key:"render",value:function(){var t=this;return!this._content||this.options.config.checksum&&!this.check()?this.fallback().then(function(){t.state.runScript&&o(t.state.runScript,"js",t.attrs)}):Promise.resolve(o(this._content,"js",this.attrs)).then(function(){t.state.runScript&&o(t.state.runScript,"js",t.attrs)})}},{key:"filename",get:function(){return this.state.filename}}],[{key:"type",get:function(){return U}}]),e}(D),q="css",Q=function(t){function e(t,n,r){E(this,e);var o=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,r));return o.type=q,o}return S(e,t),A(e,[{key:"render",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:o,e=arguments[1];return!this._content||this.options.config.checksum&&!this.check()?this.fallback(e):Promise.resolve(t(this._content,"css",this.attrs))}},{key:"filename",get:function(){return this.state.filename}}],[{key:"type",get:function(){return q}}]),e}(D),H=function(){function t(e){E(this,t),this.state=e,this.version="2.3.7",this.running=!0,this.type="tiny",this.starkAppKey=this.state.StarkOptions?this.state.StarkOptions.projectName:"",this._chunks=[],this.init()}return A(t,[{key:"set",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.nonce,n=t.publicPath,r=t.attrs,o=t.fallbackCDN;e&&(this._chunkOptions.attrs.nonce=e),r&&u(this._chunkOptions.attrs,r),n&&(this._chunkOptions.config.publicPath=n),o&&(this._chunkOptions.config.fallbackCDN=o)}},{key:"init",value:function(){var e=this;P&&(window.__thunder__=this),t._installedPlugins.forEach(function(t){return t(e)}),this.logger||(this.logger=M),this._chunkOptions={attrs:u({},this.state.outputOptions.attrs),config:this.state.outputOptions,cacheAge:this.state.cacheAge,store:this.store,logger:this.logger,updateAdapter:this.updateAdapter.bind(this)},this.state.resources.forEach(function(n){t.Chunks.forEach(function(t){n.type===t.type&&e._chunks.push(new t(n.name,n,e._chunkOptions))})}),this.store.saveChunksMap(this._chunks.map(function(t){return t.cacheKey})),this.logger.markOnce("init",{channel:"lx",SWSupport:this.serviceWorkerManager&&this.serviceWorkerManager.isSupport(),useSW:!!this.state.serviceWorker,reason:"init"})}},{key:"updateAdapter",value:function(t,e){return this._updateAdapter?this._updateAdapter(t,e,this,{Promise:Promise,request:r,debug:c,logger:this.logger}):Promise.resolve()}},{key:"bundleLoader",value:function(t){return this.parallel(t)}},{key:"styleLoader",value:function(t){return this.parallelStyle(t)}},{key:"parallelStyle",value:function(t){return this.parallel(t,"css")}},{key:"load",value:function(t,e){var n=this,r=Promise.resolve();return t.forEach(function(t){t.action=t.action||"load","load"===t.action&&(r=r.then(function(){return n.parallel(t.chunks,t.type)}))}),t.forEach(function(t){"prefetch"===t.action&&(r=r.then(function(){return n.prefetch(t.chunks,t.type)}))}),r.then(function(){e&&e()}),r}},{key:"parallel",value:function(t,e){var n=this._getChunks(t,e);return Promise.all(n.map(function(t){return t.load()})).then(function(){var t=Promise.resolve();return n.forEach(function(e){t=t.then(function(){return e.render()})}),t}).catch(function(t){return console.error(t)})}},{key:"prefetch",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=this._getChunks(t);return e=e.concat(this._getChunks(t,"css")),new Promise(function(t,e){setTimeout(t,500)}).then(function(){var t=[];return e.map(function(e){e._content||t.push(e)}),Promise.all(t.map(function(t){return t.getContent()}))})}},{key:"_getChunks",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"js",r=void 0,o=[];return r="string"==typeof t?[t]:t,r.forEach(function(t){e._chunks.forEach(function(e){e.type===n&&t===e.name&&o.push(e)})}),o}}]),t}();H.StyleChunk=Q,H.ScriptChunk=F,H.BaseChunk=D,H.Chunks=[Q,F],H._installedPlugins=[],H.use=function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];var r=e.shift(),o=this._installedPlugins;return!r||o.indexOf(r)>-1?this:(o.push(r),this)};var z=P&&"performance"in window&&"now"in performance,B=function(){function t(){E(this,t),this.logQueue=[],this._timer=null,this._delay=100,this._url="//report.meituan.com",this.report=this.report.bind(this)}return A(t,[{key:"_report",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l,n=d(),o=d(),i=document.cookie.replace(/(?:(?:^|.*;\s*)_lxsdk_cuid\s*=\s*([^;]*).*$)|^.*$/,"$1"),a=this.logQueue.map(function(t){var e=d().slice(0,4),n=d();return t.lxid=i,{req_id:n,val_cid:t.cid?t.cid:"c_c4nzgz77",nt:0,isauto:7,tm:t.createdAt,val_lab:t,val_bid:t.bid||"b_w006udto",seq:+e,nm:"MV"}});return r({url:this._url,method:"post",data:[{category:"data_sdk_smartpay",sdk_ver:"4.3.0",ct:"www",ch:"web",ua:navigator&&navigator.userAgent,sc:"640*360",uuid:o,lxid:i,msid:n,appnm:"qrcode_pay_fe",evs:a}]}).then(function(){t.logQueue.length=0,e()}).catch(function(t){t&&console.log(t),e(t)})}},{key:"report",value:function(t,e){var n=this;t.createdAt=Date.now(),this.logQueue.push(t),this._timer&&clearTimeout(this._timer),this._timer=setTimeout(function(){n._timer=null,n._report(e)},this._delay)}}]),t}(),W=new B,J=function(){function t(e){var n=e.project,r=e.version,o=e.starkAppKey;E(this,t),this.project=n,this.version=r,this.starkAppKey=o,this.logQueue=[],this.markQueue={},this._reporters=[{reporter:W.report,channel:"lx"}],this._timer=null}return A(t,[{key:"use",value:function(t,e){if("function"==typeof t){var n=!1;this._reporters.map(function(e){e.reporter===t&&(n=!0)}),n||this._reporters.push({channel:e,reporter:t})}}},{key:"mark",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t&&(this.markQueue[t]={createdAt:v(),data:e})}},{key:"markEnd",value:function(t,e,n){var r=this.markQueue[t];if(r){var o=v(),i=o-r.createdAt,a={key:t,data:u(n?{}:{project:this.project,starkAppKey:this.starkAppKey,cost:i,name:t,version:this.version},r.data,e)};if(a.error)return console.log(a.err);a.data.cost&&(a.data.cost=Math.floor(a.data.cost)),this.logQueue.push(a),delete this.markQueue[t],this.report()}}},{key:"markOnce",value:function(t,e,n){this.mark(t,e),this.markEnd(t,e,n)}},{key:"report",value:function(){this._timer&&clearTimeout(this._timer),this._timer=setTimeout(this._report.bind(this),300)}},{key:"_report",value:function(){var t=this;this._timer=null,this.logQueue.forEach(function(e){e.data&&t._reporters.forEach(function(t){e.data.channel?t.channel===e.data.channel&&t.reporter(e.data):t.reporter(e.data)})}),this.logQueue.length=0}}]),t}(),V=function(t){t.logger=new J({version:t.version,project:t.state.project,starkAppKey:t.starkAppKey})},G="Thunder",Y=function(){function t(e){var n=e.version,r=e.project,o=void 0===r?"":r;E(this,t),this.type="LSCache",this.prefix=G+"#"+o,this._storekey=this.prefix+":store",this.storage=N&&window.localStorage,this.state={size:0,count:0,version:n,cacheMap:{},chunks:[]},this._delay=100,this._saveTimer=null,this._load()}return A(t,[{key:"_save",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._delay;if(N){var n=function(){var e=JSON.stringify(t.state);try{t.storage.setItem(t._storekey,e)}catch(e){t.clear(),c("error",e)}};if(0===e)return n();this._saveTimer&&clearTimeout(this._saveTimer),this._saveTimer=setTimeout(function(){n()},e)}}},{key:"_load",value:function(){if(N)try{this.storage.setItem(G+"?v",this.state.version);var t=this.storage.getItem(this._storekey);if(!t)return;var e=JSON.parse(t);this._schemaCheck(e)&&(this.state=e)}catch(t){this.clear(),c("error",t)}}},{key:"_schemaCheck",value:function(t){var e=this,n=!0,r=Object.prototype.toString;return h(this.state).forEach(function(o){n&&(n=r.call(t[o])===r.call(e.state[o]))}),h(t).forEach(function(t){void 0===e.state[t]&&(n=!1)}),n}},{key:"_getChunkName",value:function(t){return this.prefix+"~"+t}},{key:"_updateStateInfo",value:function(){var t=this,e=0,n=0;h(this.state.cacheMap).forEach(function(r){e+=t.state.cacheMap[r].size||0,n++}),this.state.size=e,this.state.count=n}},{key:"saveChunksMap",value:function(t){this.state.chunks=t,this._save(0),this.clearAbandonedChunkCache(t)}},{key:"clearAbandonedChunkCache",value:function(t){var e=this;if(N){var n=this.prefix+"~",r=new RegExp(n),o=[];h(this.storage).forEach(function(t){r.test(t)&&o.push(t.replace(n,""))}),o.forEach(function(n){-1===t.indexOf(n)&&e.remove(n)})}}},{key:"_get",value:function(t){if(!N)return null;var e=this.storage.getItem(this._getChunkName(t)),n=this.state.cacheMap[t];if(!e||!n)return this.remove(t),null;if(n.expireAt){var r=Date.now();if(n.expireAt<r)return null}return O({},n,{content:e})}},{key:"get",value:function(t){return Promise.resolve(this._get(t))}},{key:"add",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!N)return!1;try{var n=t.name,r=t.hash,o=t.content,i=t.filename,a=t.cacheAge;this.storage.setItem(this._getChunkName(n),o);var s=Date.now(),c=0;return a&&(c=s+1e3*a),this.state.cacheMap[n]={loadedAt:s,size:Math.round(o.length/1024),hash:r,expireAt:c,filename:i},this._updateStateInfo(),this._save(),Promise.resolve(!0)}catch(n){return e&&this.retryAdd(t,3),Promise.resolve(!1)}}},{key:"retryAdd",value:function(t,e){if(!e)return c("retry add failed  "+t.name+" is too large: "+Math.floor(t.content.length/1024)+" KB");e--,this.free(),this.add(t,!1)?c("retry add success",e):this.retryAdd(t,e)}},{key:"free",value:function(){var t=this,e=void 0,n=h(this.state.cacheMap).map(function(n){return e=t.state.cacheMap[n],{name:n,loadedAt:e.loadedAt}}).sort(function(t,e){return t.loadedAt-e.loadedAt});n.length&&this.remove(n[0].name)}},{key:"clear",value:function(){var t=this;h(this.state.cacheMap).forEach(function(e){t.remove(e)})}},{key:"remove",value:function(t){if(N){this.state.cacheMap[t]&&(delete this.state.cacheMap[t],this._updateStateInfo()),this.storage.removeItem(this._getChunkName(t)),this._save()}}}]),t}(),$=function(t){t.store=new Y({project:t.starkAppKey||t.state.project,version:t.version})},X="undefined"!=typeof window,Z=X&&"performance"in window&&"now"in performance,tt="https://jarvas-static.meituan.net/diff/",et="//jarvas-static.meituan.net/file/PROJECT_NAME?filePath=",nt={PATCH:2,FULL:1,FAILED:0},rt={CLIENT_PATCH_ERROR:416,CHECKSUM_FAILED:409,UNKNOWN_ERROR:400,LOCAL_VERSION_NOT_FOUND:205};y.prototype=new Error,y.prototype.constructor=y;var ot=function(){function t(e,n,r,o){var i=n.localChunk,a=n.remoteChunk;E(this,t),this.chunkName=e,this.localChunk=i||{},this.remoteChunk=a,this.options=r,this.helpers=o}return A(t,[{key:"report",value:function(t,e){var n=t.status,r=t.statusCode,o=t.loadCost,i=this.chunkName,a=this.localChunk,s=this.remoteChunk.hash||this.remoteChunk.filename;this.helpers.logger.markOnce("stark:"+i,{channel:"lx",appKey:this.options.projectName,fileName:i,currentVersion:a.hash,diffVersion:s,saveSize:Math.max(e.fullLength-e.patchLength,0),diffState:n,diffDetailState:r,patchLength:e.patchLength,fullLength:e.fullLength,recoverCost:e.recoverCost,loadCost:o,checksum:e.checksum},!1)}},{key:"getDiff",value:function(){var t=this,e=this.chunkName,n=this.localChunk,r=this.remoteChunk.hash,o=_(e,this.localChunk,this.remoteChunk,this.options);if(!n||!n.filename||!n.content)return this.helpers.Promise.resolve();var i=m();return this.helpers.request(o).then(function(e){var r=g(e,n.content),o=r.status,a=r.statusCode,s=r.content;return t.report({status:o,statusCode:a,loadCost:m()-i},r),s}).then(function(t){return{name:e,content:t,hash:r,from:"diff"}},function(e){t.helpers.debug("error","getDiff failed",e);var r=void 0;r=n.hash?e.statusCode||rt.UNKNOWN_ERROR:rt.LOCAL_VERSION_NOT_FOUND;var o=e&&e.result||{};return t.report({status:nt.FAILED,statusCode:r},o),t.helpers.Promise.resolve()})}}]),t}();return window.Promise=j,H.use(V).use($).use(function(){return b(H)}),H});
