/*!
 * Thunder.js v2.3.7
 * (c) 2019-07-02 14:28:13 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Thunder=e()}(this,function(){"use strict";function t(t,e){window.fetch(t.url,{method:t.method,body:t.body}).then(function(t){return t.ok?t.text():e(t)}).then(function(t){e(null,t)}).catch(e)}function e(t,e){var n=new window.XMLHttpRequest;n.withCredentials=!1,n.open(t.method,t.url,!0),n.onreadystatechange=function(){4===n.readyState&&(200===n.status?(n.onreadystatechange=null,e(null,n.responseText)):e(new Error("ThunderError: content load failed")))},n.send(t.body)}function n(n,r){if(!l)return r(new Error("ThunderError: not in browser"));var o={method:"GET",data:null,url:"",body:void 0};return"string"==typeof n?o.url=n:u(o,n),o.method||(o.method=y.method),o.method=o.method.toUpperCase(),o.data&&(o.body=JSON.stringify(o.data)),f?t(o,r):e(o,r)}function r(t,e,n){var r=document.head||document.getElementsByTagName("head")[0],o=void 0;return"js"===e?(o=document.createElement("script"),o.type="text/javascript",o.charset="utf-8",o.text=t):(o=document.createElement("style"),o.type="text/css",o.charset="utf-8",o.textContent=t),n&&a(n).forEach(function(t){o.setAttribute(t,n[t])}),r.appendChild(o),"function"==typeof o.onload&&o.onload(),o}function o(t){var e=document.createElement("script");return e.type="text/javascript",e.charset="utf-8",e.async=!0,e.timeout=12e4,e.src=t,e}function i(t){var e=document.createElement("link");return e.rel="stylesheet",e.href=t,e.timeout=12e4,e.src=t,e}function s(t,e,n,r){function s(t){d(),l.onerror=l.onload=null,clearTimeout(p),r(t)}function u(){f(),l.onerror=l.onload=null,clearTimeout(p),r(null,l)}var c=document.head||document.getElementsByTagName("head")[0],l=void 0;if("js"===e?(l=o(t),n&&a(n).forEach(function(t){l.setAttribute(t,n[t])})):"css"===e&&(l=i(t)),!l)return r(new Error("execModuleAsyncLoad: wrong type with "+e));var d=h,f=h;"function"==typeof l.onerror&&(d=l.onerror),"function"==typeof l.onload&&(f=l.onload),l.onerror=s,l.onload=u;var p=setTimeout(function(){s(new Error("execModuleAsyncLoad: timeout "+t))},12e4);return c.appendChild(l),l}function u(t,e){if(void 0===t||null===t)throw new TypeError("Cannot convert first argument to object");for(var n=Object(t),r=1;r<arguments.length;r++){var o=arguments[r];if(void 0!==o&&null!==o)for(var i=a(Object(o)),s=0,u=i.length;s<u;s++){var h=i[s],c=Object.getOwnPropertyDescriptor(o,h);void 0!==c&&c.enumerable&&(n[h]=o[h])}}return n}function a(t){if(!p&&Object.keys)return Object.keys(t);if(t!==Object(t))throw new TypeError("Object.keys called on a non-object");var e=[],n=void 0;for(n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.push(n);return e}function h(){}function c(t,e){for(var n,r,o=-1^e,i=0,s=t.length;i<s;)n=t.charCodeAt(i++),n<128?o=o>>>8^k[255&(o^n)]:n<2048?(o=o>>>8^k[255&(o^(192|n>>6&31))],o=o>>>8^k[255&(o^(128|63&n))]):n>=55296&&n<57344?(n=64+(1023&n),r=1023&t.charCodeAt(i++),o=o>>>8^k[255&(o^(240|n>>8&7))],o=o>>>8^k[255&(o^(128|n>>2&63))],o=o>>>8^k[255&(o^(128|r>>6&15|(3&n)<<4))],o=o>>>8^k[255&(o^(128|63&r))]):(o=o>>>8^k[255&(o^(224|n>>12&15))],o=o>>>8^k[255&(o^(128|n>>6&63))],o=o>>>8^k[255&(o^(128|63&n))]);return(-1^o)>>>0}var l="undefined"!=typeof window,d=function(t){if(!t)return!1;try{var e="__LS_SUPPORT_TEST_KEY__";return t.setItem(e,e),t.removeItem(e,e),!0}catch(t){return!1}}(window.localStorage),f=(l&&"DEBUG_THUNDER"in window&&window.DEBUG_THUNDER,l&&"fetch"in window),p=l&&"UNIT_TEST_THUNDER"in window&&window.UNIT_TEST_THUNDER,y={method:"GET",data:null,url:""},k=function(){for(var t=0,e=new Array(256),n=0;256!==n;++n)t=n,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,t=1&t?-306674912^t>>>1:t>>>1,e[n]=t;return"undefined"!=typeof Int32Array?new Int32Array(e):e}(),g=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},_=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),m=function(){function t(e,n,r){g(this,t),this.type=n.type||"",this.name=e,this.state=n,this.options=r,this.store=r.store,this.logger=r.logger,this._updateAdapter=r.updateAdapter,this._content=n.content||""}return _(t,[{key:"_runScript",value:function(){this.state.runScript&&r(this.state.runScript,"js",this.attrs)}},{key:"_request",value:function(t){var e=this;n(this.link,function(r,o){if(r)return n(e.fallbackLink,function(n,r){n&&t(n),e._content=r,t()});e._content=o,t()})}},{key:"check",value:function(){if(void 0===this.state.checksum)return!0;var t=c(this._content),e=t===this.state.checksum;return this.logger.markOnce("check:"+this.cacheKey,{chunkName:this.cacheKey,channel:"lx",reason:"chunkChecksum",size:Math.floor(this._content.length/1024),originChecksum:this.state.checksum,isMatch:e,currentChecksum:t}),e}},{key:"render",value:function(){if(!this._content||this.options.config.checksum&&!this.check())return this.fallback();r(this._content,this.type,this.attrs),this._runScript()}},{key:"fallback",value:function(){var t=this;return new Promise(function(e,n){t._fallback(function(t){if(t)return n(t);e()})})}},{key:"_fallback",value:function(t){var e=this;if(this.state.content)return r(this.state.content,this.type,this.attrs),t();s(this.link,this.type,this.attrs,function(n){if(!n)return e._runScript(),t();e.logger.markOnce("bootloader:"+e.cacheKey,{chunkName:e.cacheKey,reason:"bootFailure"}),s(e.fallbackLink,e.type,e.attrs,function(n){if(n)return e.logger.markOnce("bootloader:"+e.cacheKey,{chunkName:e.cacheKey,reason:"bootFallbackFailure"}),t(n);e._runScript(),t()})})}},{key:"cacheKey",get:function(){return"<"+this.type+">:"+this.name}},{key:"link",get:function(){return this.state.link?this.state.link:this.options.config.publicPath+this.filename}},{key:"fallbackLink",get:function(){return this.state.link?this.state.link:(this.options.config.fallbackCDN||this.options.config.publicPath)+this.filename}},{key:"filename",get:function(){return this.state.filename}},{key:"attrs",get:function(){return u({"thunder-cache-key":this.cacheKey,crossorigin:this.options.config.crossOriginLoading},this.options.attrs,this.state.attrs)}}]),t}(),v=function(){function t(e){g(this,t),this.options=e,this._logQueue=[],this._logger=null}return _(t,[{key:"set",value:function(t){this._logger=t,this.send()}},{key:"send",value:function(){this._logger&&(this._logger.logQueue=this._logger.logQueue.concat(this._logQueue),this._logQueue.length=0,this._logger.report())}},{key:"markOnce",value:function(t,e){var n={key:t,data:u({channel:"lx",from:"bootloader",version:this.options.version,project:this.options.project,starkAppKey:this.options.starkAppKey},e)};this._logQueue.push(n),this.send()}}]),t}();return function(){function t(e){g(this,t),this.state=e,this._chunks=[],this.running=!0,this.type="bootloader",this.version="2.3.7",this.project=this.state.project,this.starkAppKey=this.state.StarkOptions?this.state.StarkOptions.projectName:"",this.logger=new v({version:this.version,project:this.state.project,starkAppKey:this.starkAppKey}),this._chunkOptions={attrs:u({},this.state.outputOptions.attrs),config:this.state.outputOptions,cacheAge:this.state.cacheAge,store:null,logger:this.logger,updateAdapter:null},this._thunderCacheKey="Thunder#"+(this.starkAppKey||this.project)+":sdk",this.thunderSDKChunk=new m("thunder-sdk",u({type:"js"},this.state.outputOptions.thunder),this._chunkOptions),this._thunder=null,this._records=[],this._timer=null,this.init()}return _(t,[{key:"init",value:function(){var t=this;l&&(window.__thunder__=this),this.tryInitThunder(),this._thunder||this.state.resources.map(function(e){t._chunks.push(new m(e.name,e,t._chunkOptions))})}},{key:"tryInitThunder",value:function(){if(d){try{if(localStorage[this._thunderCacheKey])return this.thunderSDKChunk._content=localStorage[this._thunderCacheKey],this._createThunder()}catch(t){console.error(t)}this._setLoadThunderJob()}}},{key:"_setLoadThunderJob",value:function(){var t=this;clearTimeout(this._timer),this._timer=setTimeout(function(){t.loadThunder()},1200)}},{key:"_clearThunderCache",value:function(){localStorage.removeItem(this._thunderCacheKey)}},{key:"_createThunder",value:function(){if(this.thunderSDKChunk._content){if(this.thunderSDKChunk.render(),!("Thunder"in window)||this instanceof window.Thunder)return this._clearThunderCache();var t=new window.Thunder(this.state);this._thunder=t,this.logger.markOnce("bootInit",{reason:"bootInit"}),u(t._chunkOptions.attrs,this._chunkOptions.attrs),u(t._chunkOptions.config,this._chunkOptions.config),this.logger.set(t.logger),this._records.forEach(function(e){var n=e.chunkNames,r=e.type,o=t._getChunks(n,r);Promise.all(o.map(function(t){return t.load()})).then(function(){console.log("cached!")})})}}},{key:"loadThunder",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:h;if(this._thunder)return e();this.thunderSDKChunk._request(function(n){return t.logger.markOnce("bootLoadThunder",{reason:"bootLoadThunder",success:!n,message:n&&n.message||""}),n?e(n):t.thunderSDKChunk._content?(localStorage[t._thunderCacheKey]=t.thunderSDKChunk._content,t._createThunder(),void e()):e(new Error("loadThunder: empty js content"))})}},{key:"load",value:function(t,e){var n=this;return"Promise"in window?this._load(t,e):(this.running=!1,this.loadThunder(function(r){return r?n.loadThunder(function(){return n._load(t,e)}):n._load(t,e)}))}},{key:"bundleLoader",value:function(t){return this.parallel(t,"js")}},{key:"scriptLoader",value:function(t){return this.parallel(t,"js")}},{key:"styleLoader",value:function(t){return this.parallel(t,"css")}},{key:"parallel",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"js";if(this._thunder)return this._thunder.parallel(t,n);this._records.push({chunkNames:t,type:n});var r=this._getChunks(t,n),o=Promise.resolve();return r.forEach(function(t){o=o.then(function(){return t.fallback()})}),o.then(function(){e._setLoadThunderJob()}),o}},{key:"_load",value:function(t,e){var n=this,r=Promise.resolve();return t.forEach(function(t){t.action=t.action||"load","load"===t.action&&(r=r.then(function(){return n.parallel(t.chunks,t.type)}))}),r.then(function(){e&&e()}),r}},{key:"_getChunks",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"js",r=void 0,o=[];return r="string"==typeof t?[t]:t,r.forEach(function(t){e._chunks.forEach(function(e){e.type===n&&t===e.name&&o.push(e)})}),o}}]),t}()});
