/*!
 * Thunder.js v2.3.7
 * (c) 2019-07-02 14:28:13 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Thunder=t()}(this,function(){"use strict";function e(e,t){window.fetch(e.url,{method:e.method,body:e.body}).then(function(e){return e.ok?e.text():t(e)}).then(function(e){t(null,e)}).catch(t)}function t(e,t){var n=new window.XMLHttpRequest;n.withCredentials=!1,n.open(e.method,e.url,!0),n.onreadystatechange=function(){4===n.readyState&&(200===n.status?(n.onreadystatechange=null,t(null,n.responseText)):t(new Error("ThunderError: content load failed")))},n.send(e.body)}function n(n,r){if(!V)return r(new Error("ThunderError: not in browser"));var o={method:"GET",data:null,url:"",body:void 0};return"string"==typeof n?o.url=n:u(o,n),o.method||(o.method=Q.method),o.method=o.method.toUpperCase(),o.data&&(o.body=JSON.stringify(o.data)),q?e(o,r):t(o,r)}function r(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:f;return new Promise(function(r,o){n(e,function(e,n){e?(t(e),o(e)):(t(null,n),r(n))})})}function o(e,t,n){var r=document.head||document.getElementsByTagName("head")[0],o=void 0;return"js"===t?(o=document.createElement("script"),o.type="text/javascript",o.charset="utf-8",o.text=e):(o=document.createElement("style"),o.type="text/css",o.charset="utf-8",o.textContent=e),n&&h(n).forEach(function(e){o.setAttribute(e,n[e])}),r.appendChild(o),"function"==typeof o.onload&&o.onload(),o}function i(e){var t=document.createElement("script");return t.type="text/javascript",t.charset="utf-8",t.async=!0,t.timeout=12e4,t.src=e,t}function a(e){var t=document.createElement("link");return t.rel="stylesheet",t.href=e,t.timeout=12e4,t.src=e,t}function c(e,t,n,r){function o(e){l(),u.onerror=u.onload=null,clearTimeout(p),r(e)}function c(){d(),u.onerror=u.onload=null,clearTimeout(p),r(null,u)}var s=document.head||document.getElementsByTagName("head")[0],u=void 0;if("js"===t?(u=i(e),n&&h(n).forEach(function(e){u.setAttribute(e,n[e])})):"css"===t&&(u=a(e)),!u)return r(new Error("execModuleAsyncLoad: wrong type with "+t));var l=f,d=f;"function"==typeof u.onerror&&(l=u.onerror),"function"==typeof u.onload&&(d=u.onload),u.onerror=o,u.onload=c;var p=setTimeout(function(){o(new Error("execModuleAsyncLoad: timeout "+e))},12e4);return s.appendChild(u),u}function s(){if(H){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t[0],o=void 0;console[r]?(o=console[r],t.shift()):o=console.log,t.unshift("[Thunder]"),o.apply(console,t)}}function u(e,t){if(void 0===e||null===e)throw new TypeError("Cannot convert first argument to object");for(var n=Object(e),r=1;r<arguments.length;r++){var o=arguments[r];if(void 0!==o&&null!==o)for(var i=h(Object(o)),a=0,c=i.length;a<c;a++){var s=i[a],u=Object.getOwnPropertyDescriptor(o,s);void 0!==u&&u.enumerable&&(n[s]=o[s])}}return n}function h(e){if(!$&&Object.keys)return Object.keys(e);if(e!==Object(e))throw new TypeError("Object.keys called on a non-object");var t=[],n=void 0;for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}function f(){}function l(e,t){for(var n,r,o=-1^t,i=0,a=e.length;i<a;)n=e.charCodeAt(i++),n<128?o=o>>>8^X[255&(o^n)]:n<2048?(o=o>>>8^X[255&(o^(192|n>>6&31))],o=o>>>8^X[255&(o^(128|63&n))]):n>=55296&&n<57344?(n=64+(1023&n),r=1023&e.charCodeAt(i++),o=o>>>8^X[255&(o^(240|n>>8&7))],o=o>>>8^X[255&(o^(128|n>>2&63))],o=o>>>8^X[255&(o^(128|r>>6&15|(3&n)<<4))],o=o>>>8^X[255&(o^(128|63&r))]):(o=o>>>8^X[255&(o^(224|n>>12&15))],o=o>>>8^X[255&(o^(128|n>>6&63))],o=o>>>8^X[255&(o^(128|63&n))]);return(-1^o)>>>0}function d(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9;return Math.floor(Math.random()*(t-e+1))+e}function p(){for(var e=16,t="";e--;)t+=""+d();return t}function _(){return re?performance.now():Date.now()}function m(e){return Array.prototype.slice.call(e)}function v(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function y(e,t,n){var r,o=new Promise(function(o,i){r=e[t].apply(e,n),v(r).then(o,i)});return o.request=r,o}function g(e,t,n){var r=y(e,t,n);return r.then(function(e){if(e)return new I(e,r.request)})}function E(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]},set:function(e){this[t][n]=e}})})}function k(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return y(this[t],r,arguments)})})}function w(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function D(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return g(this[t],r,arguments)})})}function b(e){this._index=e}function I(e,t){this._cursor=e,this._request=t}function A(e){this._store=e}function O(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)},e.onabort=function(){n(e.error)}})}function T(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new O(n)}function N(e){this._db=e}function S(){return $e?Math.floor(performance.now()):Date.now()}function P(e,t,n){this.message=e,this.statusCode=t,this.result=n||{}}function C(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=t.split("\t"),r=e,o=0,i=S(),a=0;a<n.length;a++){var c=n[a][0];if("="===c)o+=parseInt(n[a].slice(1),10);else if("-"===c){var s=parseInt(n[a].slice(1),10);r=r.slice(0,o)+r.slice(o+s)}else{if("+"!==c)throw new P("Broken patch found",Je.CLIENT_PATCH_ERROR);var u=decodeURI(n[a].slice(1));r=r.slice(0,o)+u+r.slice(o),o+=u.length}}return{content:r,fullLength:r.length,patchLength:t.length,recoverCost:S()-i}}function R(e,t){var n=JSON.parse(e),r=void 0;if(n.status===Xe.FAILED)throw new P("Stark service down",n.code);if(n.status===Xe.FULL&&(r={status:n.status,statusCode:n.code,content:n.content,fullLength:n.content.length,patchLength:n.content.length,checksum:n.newFileChecksum}),n.status===Xe.PATCH){var o=C(t,n.content);r={status:n.status,statusCode:n.code,content:o.content,fullLength:o.fullLength,patchLength:o.patchLength,checksum:n.newFileChecksum}}return r}function B(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=r.address,i=r.projectName,a=o||Qe;if(t&&t.hash){var c=t.filename,s=n.filename;return""+a+i+"?oldFilePath="+encodeURIComponent(c)+"&newFilePath="+encodeURIComponent(s)}}function L(e,t,n,r){if(!n.state.StarkOptions)return r.Promise.resolve();var o=n.state.StarkOptions,i=o.projectName,a=o.fallback,c=a||Ye.replace("PROJECT_NAME",i);return n.set({fallbackCDN:c}),new ze(e,t,n.state.StarkOptions,r).getDiff()}function x(e){e.prototype._updateAdapter=L}var j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},M=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},U=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),K=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},F=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},W=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},G=function(e){function t(e){return"[object Array]"===Object.prototype.toString.call(e)}function n(){for(var e=0;e<D.length;e++)D[e][0](D[e][1]);D=[],p=!1}function r(e,t){D.push([e,t]),p||(p=!0,w(n,0))}function o(e,t){function n(e){c(t,e)}function r(e){u(t,e)}try{e(n,r)}catch(e){r(e)}}function i(e){var t=e.owner,n=t.state_,r=t.data_,o=e[n],i=e.then;if("function"==typeof o){n=g;try{r=o(r)}catch(e){u(i,e)}}a(i,r)||(n===g&&c(i,r),n===E&&u(i,r))}function a(e,t){var n;try{if(e===t)throw new TypeError("A promises callback cannot return that same promise.");if(t&&("function"==typeof t||"object"===(void 0===t?"undefined":j(t)))){var r=t.then;if("function"==typeof r)return r.call(t,function(r){n||(n=!0,t!==r?c(e,r):s(e,r))},function(t){n||(n=!0,u(e,t))}),!0}}catch(t){return n||u(e,t),!0}return!1}function c(e,t){e!==t&&a(e,t)||s(e,t)}function s(e,t){e.state_===v&&(e.state_=y,e.data_=t,r(f,e))}function u(e,t){e.state_===v&&(e.state_=y,e.data_=t,r(l,e))}function h(e){var t=e.then_;e.then_=void 0;for(var n=0;n<t.length;n++)i(t[n])}function f(e){e.state_=g,h(e)}function l(e){e.state_=E,h(e)}function d(e){if("function"!=typeof e)throw new TypeError("Promise constructor takes a function argument");if(this instanceof d==!1)throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this.then_=[],o(e,this)}var p,_=e.Promise,m=_&&"resolve"in _&&"reject"in _&&"all"in _&&"race"in _&&function(){var e;return new _(function(t){e=t}),"function"==typeof e}(),v="pending",y="sealed",g="fulfilled",E="rejected",k=function(){},w="undefined"!=typeof setImmediate?setImmediate:setTimeout,D=[];return d.prototype={constructor:d,state_:v,then_:null,data_:void 0,then:function(e,t){var n={owner:this,then:new this.constructor(k),fulfilled:e,rejected:t};return this.state_===g||this.state_===E?r(i,n):this.then_.push(n),n.then},catch:function(e){return this.then(null,e)}},d.all=function(e){var n=this;if(!t(e))throw new TypeError("You must pass an array to Promise.all().");return new n(function(t,n){for(var r,o=[],i=0,a=0;a<e.length;a++)r=e[a],r&&"function"==typeof r.then?r.then(function(e){return i++,function(n){o[e]=n,--i||t(o)}}(a),n):o[a]=r;i||t(o)})},d.race=function(e){var n=this;if(!t(e))throw new TypeError("You must pass an array to Promise.race().");return new n(function(t,n){for(var r,o=0;o<e.length;o++)r=e[o],r&&"function"==typeof r.then?r.then(t,n):t(r)})},d.resolve=function(e){var t=this;return e&&"object"===(void 0===e?"undefined":j(e))&&e.constructor===t?e:new t(function(t){t(e)})},d.reject=function(e){return new this(function(t,n){n(e)})},m?_:d}("undefined"!=typeof window?window:"undefined"!=typeof global&&global||{}),V="undefined"!=typeof window,H=(function(e){if(!e)return!1;try{var t="__LS_SUPPORT_TEST_KEY__";e.setItem(t,t),e.removeItem(t,t)}catch(e){return!1}}(window.localStorage),V&&"DEBUG_THUNDER"in window&&window.DEBUG_THUNDER),q=V&&"fetch"in window,$=V&&"UNIT_TEST_THUNDER"in window&&window.UNIT_TEST_THUNDER,Q={method:"GET",data:null,url:""},Y={markOnce:f,mark:f,markEnd:f},X=function(){for(var e=0,t=new Array(256),n=0;256!==n;++n)e=n,e=1&e?-306674912^e>>>1:e>>>1,e=1&e?-306674912^e>>>1:e>>>1,e=1&e?-306674912^e>>>1:e>>>1,e=1&e?-306674912^e>>>1:e>>>1,e=1&e?-306674912^e>>>1:e>>>1,e=1&e?-306674912^e>>>1:e>>>1,e=1&e?-306674912^e>>>1:e>>>1,e=1&e?-306674912^e>>>1:e>>>1,t[n]=e;return"undefined"!=typeof Int32Array?new Int32Array(t):t}(),J=function(){function e(t,n,r){M(this,e),this.type="",this.name=t,this.state=n,this.options=r,this.store=r.store,this.logger=r.logger,this._updateAdapter=r.updateAdapter,this._content=""}return U(e,[{key:"load",value:function(){return this.getContent().then(f,function(e){console.error(e)})}},{key:"check",value:function(){if(void 0===this.state.checksum)return!0;this.logger.mark("check:"+this.cacheKey,{chunkName:this.cacheKey,channel:"lx",reason:"chunkChecksum",size:Math.floor(this._content.length/1024),originChecksum:this.state.checksum,reportCost:!0});var e=l(this._content),t=e===this.state.checksum;return this.logger.markEnd("check:"+this.cacheKey,{isMatch:t,currentChecksum:e}),t||(this.store.remove(this.cacheKey),!1)}},{key:"_request",value:function(){var e=this;return new Promise(function(t,n){r(e.link,function(r,o){if(r)return e.logger.markEnd("async:"+e.cacheKey,{reason:"updateFullFailure",reportCost:!0}),n(r);e._content=o,e.store.add({name:e.cacheKey,hash:e.hash,cacheAge:e.state.cacheAge||e.options.cacheAge,content:e._content,filename:e.filename}),e.logger.markEnd("async:"+e.cacheKey,{reason:"updateFullSuccess",reportCost:!0}),t(o)})})}},{key:"update",value:function(e){var t=this;return this._updateAdapter(this.name,{localChunk:e,remoteChunk:this.state}).then(function(e){return e&&e.content?(t._content=e.content,t.store.add({name:t.cacheKey,hash:t.hash,cacheAge:t.state.cacheAge||t.options.cacheAge,content:t._content,filename:t.filename}),t._content):t._request()},function(e){return console.error(e),t._request()})}},{key:"getContent",value:function(){var e=this;return this._content?Promise.resolve(this._content):(this.logger.markOnce("request:"+this.cacheKey,{chunkName:this.cacheKey,channel:"lx",reason:"request"}),this.logger.mark("async:"+this.cacheKey,{chunkName:this.cacheKey,channel:"lx",reportCost:!0}),this.store.get(this.cacheKey).then(function(t){if(!t)return e._request();var n=t.content,r=t.hash;return e.hash===r?(e.logger.markEnd("async:"+e.cacheKey,{reason:e.store.type,reportCost:!0}),e._content=n,Promise.resolve(e._content)):e.update(t)}))}},{key:"fallback",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:c;return this.logger.mark("fallback:"+this.cacheKey,{chunkName:this.cacheKey,channel:"lx",reason:"fallbackStart"}),new Promise(function(n,r){t(e.fallbackLink,e.type,e.attrs,function(o){if(!o)return e.fallbackState="fallbackSuccessFrist",n();t(e.fallbackLink,e.type,e.attrs,function(t){if(!t)return e.fallbackState="fallbackSuccessSecond",n();e.fallbackState="fallbackFailure",r(t)})})})}},{key:"cacheKey",get:function(){return"<"+this.type+">:"+this.name}},{key:"hash",get:function(){return this.state.hash||this.filename||this.link}},{key:"link",get:function(){return this.state.link?this.state.link:this.options.config.publicPath+this.filename}},{key:"fallbackState",set:function(e){this.logger.markEnd("fallback:"+this.cacheKey,{chunkName:this.cacheKey,channel:"lx",reason:e})}},{key:"fallbackLink",get:function(){return this.state.link?this.state.link:(this.options.config.fallbackCDN||this.options.config.publicPath)+this.filename}},{key:"attrs",get:function(){return u({"thunder-cache-key":this.cacheKey,crossorigin:this.options.config.crossOriginLoading},this.options.attrs,this.state.attrs)}}]),e}(),z="js",Z=function(e){function t(e,n,r){M(this,t);var o=W(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,r));return o.type=z,o}return F(t,e),U(t,[{key:"render",value:function(){var e=this;return!this._content||this.options.config.checksum&&!this.check()?this.fallback().then(function(){e.state.runScript&&o(e.state.runScript,"js",e.attrs)}):Promise.resolve(o(this._content,"js",this.attrs)).then(function(){e.state.runScript&&o(e.state.runScript,"js",e.attrs)})}},{key:"filename",get:function(){return this.state.filename}}],[{key:"type",get:function(){return z}}]),t}(J),ee="css",te=function(e){function t(e,n,r){M(this,t);var o=W(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,r));return o.type=ee,o}return F(t,e),U(t,[{key:"render",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:o,t=arguments[1];return!this._content||this.options.config.checksum&&!this.check()?this.fallback(t):Promise.resolve(e(this._content,"css",this.attrs))}},{key:"filename",get:function(){return this.state.filename}}],[{key:"type",get:function(){return ee}}]),t}(J),ne=function(){function e(t){M(this,e),this.state=t,this.version="2.3.7",this.running=!0,this.type="tiny",this.starkAppKey=this.state.StarkOptions?this.state.StarkOptions.projectName:"",this._chunks=[],this.init()}return U(e,[{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.nonce,n=e.publicPath,r=e.attrs,o=e.fallbackCDN;t&&(this._chunkOptions.attrs.nonce=t),r&&u(this._chunkOptions.attrs,r),n&&(this._chunkOptions.config.publicPath=n),o&&(this._chunkOptions.config.fallbackCDN=o)}},{key:"init",value:function(){var t=this;V&&(window.__thunder__=this),e._installedPlugins.forEach(function(e){return e(t)}),this.logger||(this.logger=Y),this._chunkOptions={attrs:u({},this.state.outputOptions.attrs),config:this.state.outputOptions,cacheAge:this.state.cacheAge,store:this.store,logger:this.logger,updateAdapter:this.updateAdapter.bind(this)},this.state.resources.forEach(function(n){e.Chunks.forEach(function(e){n.type===e.type&&t._chunks.push(new e(n.name,n,t._chunkOptions))})}),this.store.saveChunksMap(this._chunks.map(function(e){return e.cacheKey})),this.logger.markOnce("init",{channel:"lx",SWSupport:this.serviceWorkerManager&&this.serviceWorkerManager.isSupport(),useSW:!!this.state.serviceWorker,reason:"init"})}},{key:"updateAdapter",value:function(e,t){return this._updateAdapter?this._updateAdapter(e,t,this,{Promise:Promise,request:r,debug:s,logger:this.logger}):Promise.resolve()}},{key:"bundleLoader",value:function(e){return this.parallel(e)}},{key:"styleLoader",value:function(e){return this.parallelStyle(e)}},{key:"parallelStyle",value:function(e){return this.parallel(e,"css")}},{key:"load",value:function(e,t){var n=this,r=Promise.resolve();return e.forEach(function(e){e.action=e.action||"load","load"===e.action&&(r=r.then(function(){return n.parallel(e.chunks,e.type)}))}),e.forEach(function(e){"prefetch"===e.action&&(r=r.then(function(){return n.prefetch(e.chunks,e.type)}))}),r.then(function(){t&&t()}),r}},{key:"parallel",value:function(e,t){var n=this._getChunks(e,t);return Promise.all(n.map(function(e){return e.load()})).then(function(){var e=Promise.resolve();return n.forEach(function(t){e=e.then(function(){return t.render()})}),e}).catch(function(e){return console.error(e)})}},{key:"prefetch",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this._getChunks(e);return t=t.concat(this._getChunks(e,"css")),new Promise(function(e,t){setTimeout(e,500)}).then(function(){var e=[];return t.map(function(t){t._content||e.push(t)}),Promise.all(e.map(function(e){return e.getContent()}))})}},{key:"_getChunks",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"js",r=void 0,o=[];return r="string"==typeof e?[e]:e,r.forEach(function(e){t._chunks.forEach(function(t){t.type===n&&e===t.name&&o.push(t)})}),o}}]),e}();ne.StyleChunk=te,ne.ScriptChunk=Z,ne.BaseChunk=J,ne.Chunks=[te,Z],ne._installedPlugins=[],ne.use=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t.shift(),o=this._installedPlugins;return!r||o.indexOf(r)>-1?this:(o.push(r),this)};var re=V&&"performance"in window&&"now"in performance,oe=function(){function e(){M(this,e),this.logQueue=[],this._timer=null,this._delay=100,this._url="//report.meituan.com",this.report=this.report.bind(this)}return U(e,[{key:"_report",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:f,n=p(),o=p(),i=document.cookie.replace(/(?:(?:^|.*;\s*)_lxsdk_cuid\s*=\s*([^;]*).*$)|^.*$/,"$1"),a=this.logQueue.map(function(e){var t=p().slice(0,4),n=p();return e.lxid=i,{req_id:n,val_cid:e.cid?e.cid:"c_c4nzgz77",nt:0,isauto:7,tm:e.createdAt,val_lab:e,val_bid:e.bid||"b_w006udto",seq:+t,nm:"MV"}});return r({url:this._url,method:"post",data:[{category:"data_sdk_smartpay",sdk_ver:"4.3.0",ct:"www",ch:"web",ua:navigator&&navigator.userAgent,sc:"640*360",uuid:o,lxid:i,msid:n,appnm:"qrcode_pay_fe",evs:a}]}).then(function(){e.logQueue.length=0,t()}).catch(function(e){e&&console.log(e),t(e)})}},{key:"report",value:function(e,t){var n=this;e.createdAt=Date.now(),this.logQueue.push(e),this._timer&&clearTimeout(this._timer),this._timer=setTimeout(function(){n._timer=null,n._report(t)},this._delay)}}]),e}(),ie=new oe,ae=function(){function e(t){var n=t.project,r=t.version,o=t.starkAppKey;M(this,e),this.project=n,this.version=r,this.starkAppKey=o,this.logQueue=[],this.markQueue={},this._reporters=[{reporter:ie.report,channel:"lx"}],this._timer=null}return U(e,[{key:"use",value:function(e,t){if("function"==typeof e){var n=!1;this._reporters.map(function(t){t.reporter===e&&(n=!0)}),n||this._reporters.push({channel:t,reporter:e})}}},{key:"mark",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e&&(this.markQueue[e]={createdAt:_(),data:t})}},{key:"markEnd",value:function(e,t,n){var r=this.markQueue[e];if(r){var o=_(),i=o-r.createdAt,a={key:e,data:u(n?{}:{project:this.project,starkAppKey:this.starkAppKey,cost:i,name:e,version:this.version},r.data,t)};if(a.error)return console.log(a.err);a.data.cost&&(a.data.cost=Math.floor(a.data.cost)),this.logQueue.push(a),delete this.markQueue[e],this.report()}}},{key:"markOnce",value:function(e,t,n){this.mark(e,t),this.markEnd(e,t,n)}},{key:"report",value:function(){this._timer&&clearTimeout(this._timer),this._timer=setTimeout(this._report.bind(this),300)}},{key:"_report",value:function(){var e=this;this._timer=null,this.logQueue.forEach(function(t){t.data&&e._reporters.forEach(function(e){t.data.channel?e.channel===t.data.channel&&e.reporter(t.data):e.reporter(t.data)})}),this.logQueue.length=0}}]),e}(),ce=function(e){e.logger=new ae({version:e.version,project:e.state.project,starkAppKey:e.starkAppKey})};A.prototype.createIndex=function(){return new b(this._store.createIndex.apply(this._store,arguments))},A.prototype.index=function(){return new b(this._store.index.apply(this._store,arguments))},O.prototype.objectStore=function(){return new A(this._tx.objectStore.apply(this._tx,arguments))},T.prototype.createObjectStore=function(){return new A(this._db.createObjectStore.apply(this._db,arguments))},N.prototype.transaction=function(){return new O(this._db.transaction.apply(this._db,arguments))};var se;!function(){try{return["IDBIndex","IDBCursor","IDBObjectStore","IDBTransaction","IDBDatabase"].forEach(function(e){if(window&&!window[e])throw new Error(e);if(!window&&self&&!self[e])throw new Error(e)}),""}catch(e){return e.message}}()?(E(b,"_index",["name","keyPath","multiEntry","unique"]),k(b,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),D(b,"_index",IDBIndex,["openCursor","openKeyCursor"]),E(I,"_cursor",["direction","key","primaryKey","value"]),k(I,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(e){e in IDBCursor.prototype&&(I.prototype[e]=function(){var t=this,n=arguments;return Promise.resolve().then(function(){return t._cursor[e].apply(t._cursor,n),v(t._request).then(function(e){if(e)return new I(e,t._request)})})})}),E(A,"_store",["name","keyPath","indexNames","autoIncrement"]),k(A,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),D(A,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),w(A,"_store",IDBObjectStore,["deleteIndex"]),E(O,"_tx",["objectStoreNames","mode"]),w(O,"_tx",IDBTransaction,["abort"]),E(T,"_db",["name","version","objectStoreNames"]),w(T,"_db",IDBDatabase,["deleteObjectStore","close"]),E(N,"_db",["name","version","objectStoreNames"]),w(N,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[A,b].forEach(function(t){e in t.prototype&&(t.prototype[e.replace("open","iterate")]=function(){var t=m(arguments),n=t[t.length-1],r=this._store||this._index,o=r[e].apply(r,t.slice(0,-1));o.onsuccess=function(){n(o.result)}})})}),[b,A].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise(function(o){n.iterateCursor(e,function(e){return e?(r.push(e.value),void 0!==t&&r.length==t?void o(r):void e.continue()):void o(r)})})})}),se={open:function(e,t,n){var r=y(indexedDB,"open",[e,t]),o=r.request;return o&&(o.onupgradeneeded=function(e){n&&n(new T(o.result,e.oldVersion,o.transaction))}),r.then(function(e){return new N(e)})},delete:function(e){return y(indexedDB,"deleteDatabase",[e])}}):se={open:function(e,t,n){return Promise.reject(new Error("PROPERTY_NOT_SUPPORT"))},delete:function(e){return Promise.reject(new Error("PROPERTY_NOT_SUPPORT"))}};var ue=se,he=1,fe=function(){if(window&&window.Owl){var e={project:"indexeddb",devMode:location&&-1===location.href.indexOf("dianping")&&-1===location.href.indexOf("meituan"),resource:{sampleApi:1,delay:100}};return new window.Owl.OWL(e)}return""},le=function(e,t,n){var r=fe();if(r&&he>0){var o={name:t||"",statusCode:e,content:JSON.stringify(Object.assign({link:location.href,userAgent:window&&window.navigator&&window.navigator.userAgent},n))};r.addApi(o),he--}},de=function(e,t){return{code:e,msg:t,data:{},setData:function(n){return{code:e,msg:t,data:n}}}},pe={DB_NOT_SUPPORT:de(100,"该浏览器不支持IndexedDB"),PARAM_INVALID:de(101,"无效的参数"),PROPERTY_NOT_SUPPORT:de(102,"DB方法、属性不受支持"),SUCC:de(200,"成功"),DB_NOT_FOUND:de(201,"找不到数据库"),TABLE_NOT_FOUND:de(202,"找不到数据表"),DB_OPEN_FAIL:de(203,"数据库打开失败"),DB_ADD_ITEMS_FAIL:de(204,"数据库添加数据失败"),DB_GET_ITEM_FAIL:de(205,"数据库获取数据失败"),DB_GET_ITEMS_WITH_CURSOR_FAIL:de(206,"数据库使用游标获取数据失败"),DB_DELETE_ITEMS_FAIL:de(207,"删除数据失败"),DB_DELETE_FAIL:de(208,"删除数据库失败"),ITEM_EXPIRED:de(301,"数据过期了"),ITEM_NOT_FOUND:de(302,"找不到数据")},_e="expireTime",me=!1,ve=function(e,t){return new Promise(function(n,r){ue.open("IDB_MANAGER_DB",1,function(e){try{e.createObjectStore("IDB_MANAGER_STORE",{keyPath:"dbName"})}catch(e){r(e)}}).then(function(o){Se(o,"IDB_MANAGER_STORE",e).then(n).catch(function(i){if(i.code===pe.ITEM_NOT_FOUND.code){var a={};a.updateTime=Date.now(),a.dbName=e,a.tableList=t,a.version=1;var c=o.transaction("IDB_MANAGER_STORE","readwrite");c.objectStore("IDB_MANAGER_STORE").put(a).catch(r),c.complete.then(n).catch(r)}else r(i)})}).catch(r)})},ye=function(e){return new Promise(function(t,n){ue.open("IDB_MANAGER_DB",1,function(e){try{e.createObjectStore("IDB_MANAGER_STORE",{keyPath:"dbName"})}catch(e){n(e)}}).then(function(r){var o=r.transaction("IDB_MANAGER_STORE","readwrite");o.objectStore("IDB_MANAGER_STORE").delete(e).catch(n),o.complete.then(t).catch(n)}).catch(n)})},ge=function(e){return new Promise(function(t,n){ue.open("IDB_MANAGER_DB",1,function(e){try{e.createObjectStore("IDB_MANAGER_STORE",{keyPath:"dbName"})}catch(e){n(e)}}).then(function(r){Se(r,"IDB_MANAGER_STORE",e).then(function(e){t(e.data.value)}).catch(function(t){t.code===pe.ITEM_NOT_FOUND.code?n(pe.DB_NOT_FOUND,e+" is not found"):n(t)})}).catch(n)})},Ee=function(e,t){var n={},r=Date.now();return n.updateTime=r,t>0&&!isNaN(new Date(r+1e3*parseInt(t)).getTime())?n[_e]=r+1e3*parseInt(t):n[_e]=-1,Object.assign({},e,n)},ke=function(e,t,n){if(n){var r="";try{r=JSON.stringify(n)}catch(n){}t=t.setData({detailErrMsg:n.msg||n.message||n.stack||r||n.toString()}),t.code!==pe.DB_NOT_FOUND.code&&t.code!==pe.TABLE_NOT_FOUND.code&&t.code!==pe.ITEM_EXPIRED.code&&t.code!==pe.ITEM_NOT_FOUND.code&&le(t.code,t.msg,t.data)}me&&console&&console.log(t),e(t)},we=function(e){return e.reduce(function(e,t){return e.indexOf(t)<0?e.concat(t):e},[])},De=function(e,t){for(var n=0;n<e.length;n++){var r=e[n];if(!r)return"Has invalid tableName";if(t&&!t.objectStoreNames.contains(r))return r+" not found in db "+t.name}return""},be=function(){try{return["indexedDB","IDBDatabase","IDBObjectStore","IDBTransaction","IDBIndex","IDBCursor","IDBKeyRange"].forEach(function(e){if(window&&!window[e])throw new Error(e);if(!window&&self&&!self[e])throw new Error(e)}),""}catch(e){return e.message}},Ie=function(){console&&console.log("------start db debug------"),me=!0},Ae=function(e){var t=e.onlyIndex,n=e.lowerIndex,r=e.upperIndex,o=e.lowerExclusive,i=e.upperExclusive;return t||0==t?IDBKeyRange.only(t):!n&&0!=n||!r&&0!=r?n||0==n?IDBKeyRange.lowerBound(n,Boolean(o)):IDBKeyRange.upperBound(r||"",Boolean(i)):IDBKeyRange.bound(n,r,Boolean(o),Boolean(i))},Oe=function(e,t,n){return new Promise(function(r,o){if(!e)return void ke(o,pe.PARAM_INVALID,"dbName:"+e+" invalid");if(!(t instanceof Array))return void ke(o,pe.PARAM_INVALID,"tableList must be an array");var i=De(t.map(function(e){return e.tableName}));if(i)ke(o,pe.PARAM_INVALID,i);else if(t.length!==we(t.map(function(e){return e.tableName})).length)ke(o,pe.PARAM_INVALID,"tableList has duplicated tableName");else if(be())ke(o,pe.DB_NOT_SUPPORT,new Error(be()));else{var a=function(){ue.open(e,1,function(n){try{t.forEach(function(e){var t=void 0;"string"==typeof e.primaryKey&&e.primaryKey.trim()?(t=n.createObjectStore(e.tableName,{keyPath:e.primaryKey}),t.createIndex(e.primaryKey,e.primaryKey,{unique:!0})):(t=n.createObjectStore(e.tableName,{keyPath:"id",autoIncrement:!0}),t.createIndex("id","id",{unique:!0})),e.indexList&&e.indexList.forEach(function(e){e.indexName&&t.createIndex(e.indexName,e.indexName,{unique:Boolean(e.unique)})}),t.createIndex(_e,_e,{unique:!1})})}catch(t){ke(o,pe.DB_OPEN_FAIL,t),n.close(),Re(e)}}).then(function(e){ke(r,pe.SUCC.setData({db:e}))}).catch(function(e){ke(o,pe.DB_OPEN_FAIL,e)})};n?a():ve(e,t).then(a).catch(function(e){ke(o,pe.DB_OPEN_FAIL,e)})}})},Te=function(e){return new Promise(function(t,n){e?be()?ke(n,pe.DB_NOT_SUPPORT,new Error(be())):ge(e).then(function(e){Oe(e.dbName,e.tableList,!0).then(t).catch(function(e){ke(n,pe.DB_OPEN_FAIL,e)})}).catch(function(e){e.code===pe.DB_NOT_FOUND.code?ke(n,pe.DB_NOT_FOUND,e):ke(n,pe.DB_OPEN_FAIL,e)}):ke(n,pe.PARAM_INVALID,"dbName:"+e+" invalid")})},Ne=function(e,t){return new Promise(function(n,r){try{if(!(t instanceof Array))return void ke(r,pe.PARAM_INVALID,"itemList must be an array");var o=we(t.map(function(e){return e.tableName})),i=De(o,e);if(i)return void ke(r,pe.PARAM_INVALID,i);var a=e.transaction(o,"readwrite");t.forEach(function(e){var t=a.objectStore(e.tableName),n=Ee(e.item,e.maxAgeInSeconds||604800);t.put(n).catch(function(e){ke(r,pe.DB_ADD_ITEMS_FAIL,e);try{a.abort()}catch(e){}})}),a.complete.then(function(){le(pe.SUCC.code,pe.SUCC.msg),ke(n,pe.SUCC.setData({detail:"addItems succ"}))}).catch(function(e){ke(r,pe.DB_ADD_ITEMS_FAIL,e)})}catch(e){ke(r,pe.DB_ADD_ITEMS_FAIL,e)}})},Se=function(e,t,n){return new Promise(function(r,o){try{if(e.objectStoreNames.contains(t)){e.transaction(t,"readonly").objectStore(t).get(n).then(function(e){e?e[_e]>0&&e[_e]<Date.now()?ke(o,pe.ITEM_EXPIRED):ke(r,pe.SUCC.setData({value:e})):ke(o,pe.ITEM_NOT_FOUND)}).catch(function(e){ke(o,pe.DB_GET_ITEM_FAIL,e)})}else ke(o,pe.TABLE_NOT_FOUND)}catch(e){ke(o,pe.DB_GET_ITEM_FAIL,e)}})},Pe=function(e,t,n){return new Promise(function(r,o){try{if(!e.objectStoreNames.contains(t))return void ke(o,pe.TABLE_NOT_FOUND);var i=e.transaction(t,"readonly"),a=i.objectStore(t);if(n){var c=[],s=function e(t){t?(c.push(t.value),t.continue().then(e).catch(function(e){ke(o,pe.DB_GET_ITEMS_WITH_CURSOR_FAIL,e)})):ke(r,pe.SUCC.setData({values:c}))},u=a.index(n.indexName);"function"!=typeof u.openCursor?ke(o,pe.PROPERTY_NOT_SUPPORT,"index.openCursor is not supported"):u.openCursor(Ae(n)).then(s).catch(function(e){ke(o,pe.DB_GET_ITEMS_WITH_CURSOR_FAIL,e)})}else a.getAll().then(function(e){ke(r,pe.SUCC.setData({values:e||[]}))}).catch(function(e){ke(o,pe.DB_GET_ITEM_FAIL,e)})}catch(e){ke(o,pe.DB_GET_ITEMS_WITH_CURSOR_FAIL,e)}})},Ce=function(e,t){function n(t,r,o){if(t.length>0)try{var i=t[0],a=e.transaction(i,"readwrite"),c=a.objectStore(i),s=c.index(_e),u=function e(i){i?(c.delete(i.primaryKey).catch(function(e){ke(o,pe.DB_DELETE_ITEMS_FAIL,e)}),i.continue().then(e).catch(function(e){ke(o,pe.DB_DELETE_ITEMS_FAIL,e)})):n(t.slice(1),r,o)};"function"!=typeof s.openCursor?ke(o,pe.PROPERTY_NOT_SUPPORT,"index.openCursor is not supported"):s.openCursor(Ae({indexName:_e,lowerIndex:0,upperIndex:Date.now(),lowerExclusive:!1,upperExclusive:!1})).then(u).catch(function(e){ke(o,pe.DB_DELETE_ITEMS_FAIL,e)})}catch(e){ke(o,pe.DB_DELETE_ITEMS_FAIL,e)}else r()}
return new Promise(function(r,o){if(t instanceof Array){var i=we(t);De(i,e)?r():n(i,r,o)}else r()})},Re=function(e){return new Promise(function(t,n){ye(e).then(function(){ue.delete(e).then(function(){ke(t,pe.SUCC.setData({detail:"deleteDB succ"}))}).catch(function(e){ke(n,pe.DB_DELETE_FAIL,e)})}).catch(function(e){ke(n,pe.DB_DELETE_FAIL,e)})})},Be={checkDBNotSupportReason:be,setDebugger:Ie,createDB:Oe,openDB:Te,addItems:Ne,getItem:Se,getBetweenRange:Pe,deleteExpiredItems:Ce,deleteDB:Re},Le=function(){Be.setDebugger()},xe=function(){return Be.checkDBNotSupportReason()},je=function(e,t,n){return new Promise(function(r,o){e?Be.createDB("SINGLE_DATA_DB",[{tableName:"SINGLE_DATA_STORE",primaryKey:"keyName",indexList:[]}]).then(function(i){var a=i.data.db,c={};c.keyName=e,c.value=t,Be.deleteExpiredItems(a,["SINGLE_DATA_STORE"]).then(function(){Be.addItems(a,[{tableName:"SINGLE_DATA_STORE",item:c,maxAgeInSeconds:n}]).then(function(){r()}).catch(o)}).catch(o)}).catch(o):o(pe.PARAM_INVALID.setData({detailErrMsg:"keyName is invalid"}))})},Me=function(e){return new Promise(function(t,n){Be.openDB("SINGLE_DATA_DB").then(function(r){var o=r.data.db;Be.getItem(o,"SINGLE_DATA_STORE",e).then(function(e){t(e.data.value)}).catch(n)}).catch(n)})},Ue=function(e){return new Promise(function(t,n){Be.deleteDB(e).then(function(){t()}).catch(n)})},Ke=function(e,t,n){return new Promise(function(r,o){Be.openDB(e).then(function(e){Be.getItem(e.data.db,t,n).then(function(e){r(e.data.value)}).catch(o)}).catch(o)})},Fe=function(e,t,n){return new Promise(function(r,o){Be.openDB(e).then(function(e){Be.getBetweenRange(e.data.db,t,n).then(function(e){r(e.data.values)}).catch(o)}).catch(o)})},We=function(){function e(t){if(M(this,e),!t)throw new Error("CustomDB need dbConfig!");if(!t.dbName)throw new Error("CustomDB dbName invalid!");if(!(t.tableList instanceof Array))throw new Error("CustomDB tableList must be an Array");this.dbName=t.dbName,this.tableList=t.tableList}return U(e,[{key:"addItems",value:function(e){var t=this;return new Promise(function(n,r){e instanceof Array?Be.createDB(t.dbName,t.tableList).then(function(t){var o=t.data.db;Be.deleteExpiredItems(o,e.map(function(e){return e.tableName})).then(function(){Be.addItems(o,e).then(function(){n()}).catch(r)}).catch(r)}).catch(r):r(pe.PARAM_INVALID.setData({detailErrMsg:"addItems input must be an array"}))})}},{key:"getItem",value:function(e,t){var n=this;return new Promise(function(r,o){Ke(n.dbName,e,t).then(r).catch(o)})}},{key:"getBetweenRange",value:function(e,t){var n=this;return new Promise(function(r,o){Fe(n.dbName,e,t).then(r).catch(o)})}}]),e}(),Ge={setDebugger:Le,checkDBNotSupportReason:xe,getKV:Me,setKV:je,deleteDB:Ue,getItemFromDB:Ke,getBetweenRangeFromDB:Fe,CustomDB:We},Ve=function(){function e(t){var n=t.project;t.version;M(this,e),this.type="IDBCache",this.prefix="Thunder:cache:"+n,this.project=n,this.state={cacheMap:{}},this.db=Ge}return U(e,[{key:"_getCacheName",value:function(e){return this.prefix+"~"+e}},{key:"add",value:function(e){var t=e.name;return this.db.setKV(this._getCacheName(t),e,e.cacheAge||31536e3)}},{key:"get",value:function(e){return this.db.getKV(this._getCacheName(e)).then(function(e){return e.value}).catch(function(e){console.error(e)})}},{key:"saveChunksMap",value:function(){}},{key:"remove",value:function(e){return this.db.setKV(this._getCacheName(e),null,1)}},{key:"clear",value:function(e,t){}}]),e}(),He=function(e){e.store=new Ve({project:e.starkAppKey||e.state.project,version:e.version})},qe="undefined"!=typeof window,$e=qe&&"performance"in window&&"now"in performance,Qe="https://jarvas-static.meituan.net/diff/",Ye="//jarvas-static.meituan.net/file/PROJECT_NAME?filePath=",Xe={PATCH:2,FULL:1,FAILED:0},Je={CLIENT_PATCH_ERROR:416,CHECKSUM_FAILED:409,UNKNOWN_ERROR:400,LOCAL_VERSION_NOT_FOUND:205};P.prototype=new Error,P.prototype.constructor=P;var ze=function(){function e(t,n,r,o){var i=n.localChunk,a=n.remoteChunk;M(this,e),this.chunkName=t,this.localChunk=i||{},this.remoteChunk=a,this.options=r,this.helpers=o}return U(e,[{key:"report",value:function(e,t){var n=e.status,r=e.statusCode,o=e.loadCost,i=this.chunkName,a=this.localChunk,c=this.remoteChunk.hash||this.remoteChunk.filename;this.helpers.logger.markOnce("stark:"+i,{channel:"lx",appKey:this.options.projectName,fileName:i,currentVersion:a.hash,diffVersion:c,saveSize:Math.max(t.fullLength-t.patchLength,0),diffState:n,diffDetailState:r,patchLength:t.patchLength,fullLength:t.fullLength,recoverCost:t.recoverCost,loadCost:o,checksum:t.checksum},!1)}},{key:"getDiff",value:function(){var e=this,t=this.chunkName,n=this.localChunk,r=this.remoteChunk.hash,o=B(t,this.localChunk,this.remoteChunk,this.options);if(!n||!n.filename||!n.content)return this.helpers.Promise.resolve();var i=S();return this.helpers.request(o).then(function(t){var r=R(t,n.content),o=r.status,a=r.statusCode,c=r.content;return e.report({status:o,statusCode:a,loadCost:S()-i},r),c}).then(function(e){return{name:t,content:e,hash:r,from:"diff"}},function(t){e.helpers.debug("error","getDiff failed",t);var r=void 0;r=n.hash?t.statusCode||Je.UNKNOWN_ERROR:Je.LOCAL_VERSION_NOT_FOUND;var o=t&&t.result||{};return e.report({status:Xe.FAILED,statusCode:r},o),e.helpers.Promise.resolve()})}}]),e}(),Ze=function(){function e(){M(this,e),this._listeners={}}return U(e,[{key:"$on",value:function(e,t,n){return n=n||null,this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push({fn:t,ctx:n}),this._listeners[e].length-1}},{key:"$once",value:function(e,t,n){n=n||null;var r=function r(){for(var o=arguments.length,i=Array(o),a=0;a<o;a++)i[a]=arguments[a];t.apply(n,i),this.$off(e,r)};this.$on(e,r,this)}},{key:"$off",value:function(e,t){var n=this;this._listeners[e]&&this._listeners[e].length&&(t||(this._listeners[e].map(function(e){return null}),this._listeners[e].length=0),"function"==typeof t&&this._listeners[e].map(function(r,o){r.fn===t&&(n._listeners[e].splice(o,1),r=null)}))}},{key:"$emit",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];if(t.length){var r=t[0];t.shift(),this._listeners[r]&&this._listeners[r].length&&this._listeners[r].map(function(e){e.fn.apply(e.ctx,t)})}}}]),e}(),et=Boolean(V&&"serviceWorker"in navigator&&"onmessage"in navigator.serviceWorker),tt=V&&"caches"in window,nt=V&&"MessageChannel"in window,rt=Boolean(V&&("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/))),ot=Boolean(V&&"https:"===window.location.protocol),it=/^thunder:sw-event:/i,at=/\$\$\$thunder-serviceworker/,ct=function(e){function t(e,n){M(this,t);var r=W(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.state=e,r.options=e.serviceWorker,r.serviceWorker=null,r.logger=n.logger,r.cache=r.initCache(),r.ready=r._ready(),r}return F(t,e),U(t,[{key:"isSupport",value:function(){return t.isSupport()}},{key:"_ready",value:function(){var e=this;return t.isSupport()?this.options?(navigator.serviceWorker.onmessage=this.onMessage.bind(this),this._register().then(function(t){return e.serviceWorker=t,e.sendMessage({command:"update:ua",userAgent:window.navigator.userAgent}),e.report(),t})):(t.unregister(),Promise.resolve()):Promise.resolve()}},{key:"_register",value:function(){return navigator.serviceWorker.register(this.options.path+"?v="+this.state.compilation.hash,{scope:this.options.scope}).then(function(e){return e.active?e.active:new Promise(function(t,n){e.addEventListener("updatefound",function(){var n=e.installing;n.addEventListener("statechange",function(){"activated"===n.state&&t(n)})})})})}},{key:"report",value:function(){var e=this;this.sendMessage({command:"log"}).then(function(t){if(t.data||t.data instanceof Array){t.data.forEach(function(t){e.logger.markOnce("sw:cachedFetch",K({channel:"lx",reason:"swCache"},t.data,{url:t.key}))})}}).catch(function(t){e.logger.markOnce("swInitError",{channel:"lx",reason:"swInitError",message:t&&t.message,stack:t&t.toString()}),s("warn",t)})}},{key:"initCache",value:function(){var e=this;return{keys:function(){return e.sendMessage({command:"cache:keys"})},clear:function(){return e.sendMessage({command:"cache:clear"})},add:function(t){return e.sendMessage({command:"cache:add",url:t})},delete:function(t){return e.sendMessage({command:"cache:delete",url:t})}}}},{key:"sendMessage",value:function(e){var n=this;return this.ready.then(function(){return new Promise(function(r,o){if(!n.serviceWorker)return o(new Error("service-worker not ready"));if(!t.env.SUPPORT_MESSAGE_CHANNEL)return o(new Error("unsupport MessageChannel"));var i=new MessageChannel;i.port1.onmessage=function(e){e.data.error?o(e.data.error):r(e.data)},n.serviceWorker.postMessage(e,[i.port2])})})}},{key:"onMessage",value:function(e){if(e.data||!(e.data instanceof Object)){var n=e.data,r=n.type||"";if(t.env.SW_EVENT_PREFIX_REG.test(r)){var o=r.replace(t.env.SW_EVENT_PREFIX_REG,"");this.$emit(o,n)}}}},{key:"active",get:function(){return!!t.env.SUPPORT_SERVICE_WORKER&&(!!navigator.serviceWorker.controller&&"activated"===navigator.serviceWorker.controller.state)}}],[{key:"isSupport",value:function(){return t.env.SUPPORT_SERVICE_WORKER&&(t.env.IN_HTTPS||t.env.IN_LOCALHOST)}},{key:"unregister",value:function(){t.env.SUPPORT_SERVICE_WORKER&&t.env.SUPPORT_CACHE&&caches.keys&&caches.keys().then(function(e){e.forEach(function(e){t.env.THUNDER_CACHE_NAME_PRE.test(e)&&(caches.delete(e),s("cache cleard"))})}).catch(function(e){s("error","unregister",e)}),t.env.SUPPORT_SERVICE_WORKER&&(navigator.serviceWorker.getRegistration&&navigator.serviceWorker.getRegistration().then(function(e){e&&(e.unregister(),s("sw unregisted"))}).catch(function(e){s("error","unregister",e)}),navigator.serviceWorker.getRegistrations&&navigator.serviceWorker.getRegistrations().then(function(e){e.forEach(function(e){e.unregister()}),s("sw unregisted")}).catch(function(e){s("error","unregister",e)}))}}]),t}(Ze);ct.env={THUNDER_CACHE_NAME_PRE:at,SW_EVENT_PREFIX_REG:it,IN_HTTPS:ot,IN_LOCALHOST:rt,SUPPORT_MESSAGE_CHANNEL:nt,SUPPORT_CACHE:tt,SUPPORT_SERVICE_WORKER:et};var st=function(e){e.serviceWorkerManager=new ct(e.state,{logger:e.logger})};return window.Promise=G,ne.use(ce).use(He).use(st).use(function(){return x(ne)}),ne});
