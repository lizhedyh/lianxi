import {
  execModule
} from '../util'
import Chunk from './chunk'

const JSStaticType = 'js'

export default class ScriptChunk extends Chunk {
  constructor (name, state, options) {
    super(name, state, options)
    this.type = JSStaticType
  }

  static get type () {
    return JSStaticType
  }

  render () {
    if (this._content && (this.options.config.checksum ? this.check() : true)) {
      return Promise.resolve(execModule(this._content, 'js', this.attrs))
        .then(() => {
          if (!this.state.runScript) return
          execModule(this.state.runScript, 'js', this.attrs)
        })
    } else {
      // 1. 没有 _content, 加载失败
      // 2. checksum 校验和不匹配
      return this.fallback()
        .then(() => {
          if (!this.state.runScript) return
          execModule(this.state.runScript, 'js', this.attrs)
        })
    }
  }

  get filename () {
    return this.state.filename
  }
}
