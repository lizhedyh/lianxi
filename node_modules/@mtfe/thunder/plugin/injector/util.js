const assert = require('assert')

function genLoaderInitScript (chunks, styles, options, state) {
  assert(Array.isArray(chunks), 'options.chunks must be an array, but got: ', chunks)

  const jobs = [{
    type: 'css',
    action: 'load',
    chunks: styles || chunks
  }, {
    type: 'js',
    action: 'load',
    chunks: chunks
  }]

  if (options.prefetch) {
    let prefetchChunks = []
    if (Array.isArray(options.prefetch)) {
      prefetchChunks = options.prefetch
    } else if (options.prefetch === true) {
      // all
      prefetchChunks = state.resources.map(r => r.name)
    }
    jobs.push({
      action: 'prefetch',
      chunks: prefetchChunks
    })
  }

  const content = `
  ;(function (global) {
    var thunder = global.__thunder__;
    thunder.load(${JSON.stringify(jobs)})
  })(window);
  `
  return content
}

module.exports = {
  genLoaderInitScript
}
