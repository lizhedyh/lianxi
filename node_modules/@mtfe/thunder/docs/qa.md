# 常见问题

## 使用 Thunder 会对业务产生哪些影响？

Thunder 会改变的 CSS/JS 资源加载执行的方式。

会根据本地缓存情况有两种不同的方式：

同步：同步读取 LS 加载，同步执行, DOMContentLoaded 近似普通外联 JS 方式
异步：异步 (Ajax/Fetch) 请求 CDN 加载，同步执行, DOMContentLoaded 早于 业务 JS 执行

项目中对 CSS/JS 资源加载顺序有要求的话，比如灵犀等外部资源需要在 KNB 之后加载这种,需要进行一些设置

详细请参考：[JS loader 机制](https://docs.sankuai.com/doc/zcm/fe-offlinify/depth/loader/)

## 如何在 era 中使用 Thunder ?

可以直接 [era-thunder](http://npm.sankuai.com/package/@fdfe/era-thunder) 快速接入。

## 为什么要内联使用 Thunder SDK ?

通常来说，我们是希望读者将 SDK 内置到模板中的，因为我们的启动代码依赖于 sdk ，如果通过外链的方式加载的话，必然会降低应用的启动速度。如果要外链 sdk ，仅需作如下配置即可：

```javascript
...
new Thunder({
    //项目名称
    project: "example",
    //模板注入配置
    injectHTML: {
        //开发模板的绝对路径
        template: path.resolve(__dirname, 'path/to/your/template/index.html'),
        //inline false
        inline: false
    }
}),
...
```

## 如何统计页面加载性能 ？

我们建议首先需要了解一下 [Thunder 的加载模式和标签引入方式的区别](./depth/loader/#thunder)。我们推荐利用 [Cat 自定义测速点](http://cat.sankuai.com/cat/s/frontend?op=speedVue#/list) 来记录业务真实执行的时间节点来统计性能，可以通过 [页面延时趋势](http://cat.sankuai.com/cat/r/frontend?op=performanceVue) 页面中的自定义阶段查看。


## Content Security Policy (CSP) 下如何使用 Thunder ？

[Content Security Policy (CSP)](https://developers.google.com/web/fundamentals/security/csp/) 用指令来声明浏览器可以加载执行哪些资源，`Thunder` 的资源加载模式是从缓存中读取资源文本，创建内联代码注入到文档中的模式，这和 CSP 推荐的使用方式有一些冲突。不过我们依然可以在 CSP 中使用 `Thunder` 。

CSP Level 2 可为内联脚本提供向后兼容性，即允许您使用一个加密随机数（数字仅使用一次）或一个哈希值将特定内联脚本列入白名单。尽管这可能很麻烦，但它在紧急情况下很有用。

```html
<script nonce=EDNnf03nceIOfn39fn3e9h3sdfa>
  // Some inline code I cant remove yet, but need to asap.
</script>
```

现在，将随机数添加到已追加到 nonce- 关键字的 script-src 指令。

```javascript
const thunderState = require('path/to/thunder-state.json')

const thunderInjector = require('@mtfe/thunder/server/injector')({
    // path: 'path/to/thunder-state.json'
    thunderState: thunderState,
    chunks: ['manifest', 'vendor', 'app'],
    inline: true
})

app.router.get('index', function (ctx) {
    // 这里 nonceId 使用静态，在实际场景中请使用加密随机数
    const nonceId = 'EDNnf03nceIOfn39fn3e9h3sdfa'
    
    ctx.set('Content-Security-Policy', `script-src 'self' ..cdn 服务域名 等... 'nonce-${nonceId}';`)
    
    ctx.render('index.ejs', {
        styleContent: thunderInjector.getStylesContent(),
        scriptContent: thunderInjector.getScriptsContent({ nonce: nonceId })
    })
})
```


## 如何在 Nuxt 项目中接入 Thunder

和普通的 Koa / Express 类型，只需要使用 thunder 的sdk 和 初始化代码替换原来项目中的 `script` 资源引入方式即可。

在 nuxt 项目中，静态资源的引入是由 nuxt 结合 `vue-server-renderer` 模块实现的，主要机制为 `TemplateRenderer.renderScripts` 读取 `vue-ssr-client-manifest.json` 的初始化资源模块(`initial`，如 vendor manifest app) 以及在当前渲染中被调用的模块（module）所属的异步模块文件（async）

使用 Thunder 的场景，需要关闭框架的自动资源注入功能，如下是利用 hook `render:resourcesLoaded` ：

```javascript
this.nuxt.hook('render:resourcesLoaded', resources => {
    if (resources && resources.clientManifest) resources.clientManifest.initial = [''];
});
```

关闭框架内部的资源注入之后，只需要参考 [在 Koa / Express 中使用 Thunder](http://docs.sankuai.com/doc/zcm/fe-offlinify/#koa-express-thunder) 就可以完成接入了。


## 如何关闭 Thunder

`Thunder` 提供一个 `disable` 字段来控制 `Thunder` 的开启或关闭，业务方可以根据这个字段进行开启和关闭的操作，部分代码如下：

```javascript
const thunderInjector = require('@mtfe/thunder/server/injector')({
      thunderState: thunderState,

      // chunks需要严格按照wepack运行时的依赖关系
      chunks: ['manifest', 'lib', 'vendor', 'app'],

      // 模板内置SDK以及启动代码，默认为true
      inline: true,
      disable: true
    })
```
需要注意的是 `Thunder` 在关闭的情况下需要 `chunks` 来告知 `Thunder` 需要加载哪些资源，所以即使代码中使用的 `content` 来进行资源加载，也要确保代码中 `chunks` 字段中包含所有需要加载的内容。


## 如何关闭 serviceWorker

`Thunder` 关闭之后，并不会注销 `serviceWorker` 需要手动删掉 `thunderState` 中的 `serviceWorker` 字段，部分代码如下：

```javascript
const disableSwThunder = _.clone(thunderState) 
delete  disableSwThunder.serviceWorker
```


## 如何获取 UserAgent

业务方有时候会遇到需要解析 `userAgent` 的需求，但是通过 `service-worker` 处理的请求 `header` 中的 `userAgent` 可能不是容器定义的，比如下面这种：

```userAgent
Mozilla/5.0 (Linux; Android 7.0; MI 5 Build/NRD90M; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/64.0.3282.137 Mobile Safari/537.36
```
这种情况需要从 `x-thunder-user-agent` 字段中获取 `userAgent`

详细请参考：[ServiceWorker 相关问题](https://docs.sankuai.com/doc/zcm/fe-offlinify/depth/sw/#serviceworker_1)


## 如何在dev/test/staging环境启用sourcemap

如果使用thunder的默认配置，sourcemap会出现加载异常 `DevTools failed to parse SourceMap: xxxx`,导致sourcemap不能正常解析，无法映射源码,问题的原因是sourcemap加载路径不正确,解决方案如下。

首先引入static包`npm install @fdfe/era-static -D`,在`config/plugin.js`加入如下代码

```javascript
const env = process.env.NODE_ENV || 'prod';
module.exports = {
  static: {
    enable: env !== 'prod', // prod环境不开启
    package: '@fdfe/era-static',
  },
};
```

接着在`conf.default.js`里加入如下配置

```javascript
  client:{
    // 扩展 webpack 配置
      webpack(config, webpack, env) {
        // 解决thunder导致非生产环境，sourcemap不生效问题
        if (env === 'local') {
          config.devtool = '#eval-source-map';
        } else if (env !== 'prod') {
          config.devtool = '';
          config.plugins.push(
            new webpack.SourceMapDevToolPlugin({
              filename: '[file].map',
              publicPath: '/static/',
            }),
          );
        }
      },
  },
  server:{
    static: {
        maxAge: 31536000,
        dir: path.resolve(__dirname, '../static/build'),
        prefix: '/static',
    },
  }
  
```
推送dev环境后即可看到sourcemap生效


