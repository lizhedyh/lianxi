# 优化建议与常见问题

### 启用预加载

预加载可以有效减少多页应用中首屏之后的后续异步路由页面展现速度，thunder 支持直接配置开启预加载。

> 如果项目整体静态资源过大，可能存在缓存空间争抢，建议使用 thunder 的 IndexedDB 模式

在纯静态项目中只需要添加 `prefetch: true` 就可以启用

```javascript
new ThunderPlugin({
  project: 'example',
  injectHTML: [{
    chunks: ['manifest', 'vendor', 'pageA-entry'],
    prefetch: true,
    template: path.resolve(__dirname, 'path/to/your/template/pageA.html'),
    filename: 'pages/index.html'
  }]
})
```

如果是使用自定义`content`thunder 加载逻辑或是使用 era-thunder，只需要在最后添加 `thunder.prefetch()` 即可：

```javascript
new Thunder({
    //项目名称
    project: "example",
    //模板注入配置
    injectHTML: {
        template: path.resolve(__dirname, 'path/to/your/template/index.html'),
        // 使用自定义的启动脚本
        content:`
          ;(function (global) {
            var thunder = global.__thunder__;
            thunder.styleLoader(["vendor","app"])
              .then(function () {
                return thunder.parallel(["vendor","app","lx"])
              })
              .then(function () {
                return thunder.prefetch()
              })
              .then(function (list) {
                console.log("prefetch complete", list && list.length)
              })
          })(window);`
    }
})
```


### 缓存 KNB Cat 灵犀 SDK 等外链资源

在 thunder plugin 的 `resources` 配置中添加相应的资源：

```javascript
new Thunder({
    //项目名称
    project: "example",
    resources: {
      js: {
        lx: {
          link: '//analytics.meituan.net/analytics.js',
          cacheAge: 3600 * 24 * 7 // 单位为秒，7 天
        },
        cat: {
          link: '//www.dpfile.com/app/owl/static/owl_1.5.19.js',
          cacheAge: 3600 * 24 * 7 // 单位为秒，7 天,
          // cat owl SDK 需要设置 `crossorigin="anonymous"` 属性
          attrs: {
            'crossorigin': 'anonymous'
          },
          // owl SDK 加载完成后，需要执行初始化
          runScript: `
              global.Owl.start({ 
                project: 'com.sankuai.fsp.fe.thunderdemo',
                pageUrl: window.location.href,
                page: { sample: 1, auto: true },
                metric: { sample: 1, combo: true }
              });
          `
        }
      }
  },
  injectHTML: [{
    chunks: ['cat', 'manifest', 'vendor', 'lx'],
    template: path.resolve(__dirname, 'path/to/your/template/pageA.html'),
    filename: 'pages/index.html'
  }]
})
```

> 外链资源缓存持久化能够进一步减少页面请求，极大提升页面展现速度，但存在一些问题：
1. 需要确保外链资源（JS/CSS）不会因内联执行引发行为异常；
2. 需要来源 CDN 支持跨域访问

目前调研结论：

1. 灵犀 可以缓存  影响：可能会影响灵犀的灰度方案, 灵犀 SDK 无版本，建议缓存周期设置为几天内
2. Cat 可以缓存  影响：需要在缓存加载后执行 owl 相关配置
3. KNB  CDN 版本不能缓存，但可以使用 npm 版本代替


### 异步 chunk 名称

在 webpack 中将非首屏需求的组件异步化是一个很好的实践

```javascript
() => import('./MyComponent')
```

默认就会输出类似下面 `async chunk` 的文件

```
// entry chunk
app.c6e71f3f5c75987a373f.js

// async chunk
0.c6e71f3f5c75987a373f.js
1.c6e71f3f5c75987a373f.js
2.c6e71f3f5c75987a373f.js
```

但是数字化的ID可能不是一个能很好利用缓存的实践，所以，`webpack` 在 2.4.0 版本之后开始支持 `magic comments` 来对 chunk 命名

```javascript
() => import(/* webpackChunkName: 'Anything' */ './MyComponent')
```

但是如果你不想对每一个 `async chunk` 都手动命名的话，thunder 会默认实现 chunk 中深度（depth）最浅的模块（module） 的文件相对路径（相对于项目根目录 webpack.context）作为名称。

```javascript
// magic comment named chunk
Anything.c6e71f3f5c75987a373f.js

// thunder path name chunk
src-views-PageB-vue.c6e71f3f5c75987a373f.js
```

```
[path].[chunkhash].js
```

[path] 是资源的相对路径中的 `/` 或 `\` 或 `.` 替换成 `-`
[chunkhash] 来自于 webpack 的 chunkhash

如果组件文件层级比较深导致相对路径也会比较长，那么推荐使用 `pathNameHash` 来将 路径名做一次 MD5 采样压缩

`pathNameHash` 为 `true` 时，会将 chunk path-name 的转换为 MD5，长度默认为 16

```javascript
new ThunderPlugin({
  pathNameHash: true, // default: false
  pathNameHashLength: 8, // default: 16
  chunkNameResolver: (chunk : Chunk, compilation : Compilation) : String => {} // Function
})

```

会得到类似的打包文件:

```javascript
thunder-chunk-3sd2sa31d36xe1d2s.c6e71f3f5c75987a373f.js
```
