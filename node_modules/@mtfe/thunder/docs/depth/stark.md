## 启用资源增量更新

有些时候我们的项目变动很少，但是用户更新资源的时候需要全部更新，对于那些非变动的部分更新是一种浪费，在弱网环境下，更新也会非常慢。针对这种情况，thunder 结合 `Stark` 资源托管系统提供的增量更新，在资源变动时，只对更改的部分进行更新替换，同时极大地提高弱网下资源更新速度。

在使用增量更新之前请先到stark系统注册一下自己的项目[stark 地址](http://stark.sankuai.com)。项目通过之后，你可以在配置中添加以下代码就能让thunder启用增量更新：

```javascript
...
new Thunder({
    ...
    
    //启用增量更新的配置
    StarkOptions: {
        //这里的projectName是你在stark平台上获取到的项目appkey
        "projectName": "3d07127a",
        
        //配置stark预热时需要读取的目录,也就是你的资源构建后输出的目录
        "dist": "path/to/resources/output"
    }
})
...
```

相信读者在例子配置中看到了预热的字样，没错，在使用增量更新时，stark提供了预热功能，也就是提前将你的增量更新结果计算好，不用用户请求时再计算，极大提高增量更新成功率，当然，其实成功率已经很高了！关于如何在项目上线前如何预热，请查看相关的文档，非常简单，[stark预热使用](http://npm.sankuai.com/package/@mfe/stark-warmup)。

## Stark 配置

Stark 相关配置，增加 `StarkOptions` 之后 thunder 会启用 Stark 增量更新功能。


webpack plugin 配置

```javascript
new ThunderPlugin({
  StarkOptions: {
    // 项目在 Stark 管理平台上对应的 id
    "projectName": "3d07127c",
    // webpack 编译出文件的所在目录
    "dist": "dist"
  }
})
```

注意，如果启用了 Stark ，那么 webpack 所产生的资源都会一并上传到 Stark 自己的 CDN 上。此时， webpack 的 `publicPath` 也需要更改，应写为 "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:PROJECT_NAME/"。其中 `PROJECT_NAME` 需要替换为 Stark 管理平台中你自己项目对应的 id ，该 id 与 `StarkOptions` 中的 `projectName` 一致。

通常来说， webpack 的编译和上传 Stark 是分开的两个过程，通过 `thunder-stark-plugin-upload path/to/thunder-state.json` 会将资源上传至 Stark。

默认情况下， `dist` 目录下的文件都会上传到 Stark 中。为了避免上传一些明显不需要的文件，我们内置了一个黑名单，只要**文件全路径**命中了黑名单中的任意一条规则，那么这个文件就不会上传：

```javascript
[
  /\.git/,
  /node_modules/,
  /thunder-state/,
  /service-worker/,
  /\.DS_Store/,
  /\.log$/,
  /\.map$/,
];
```

如果项目还有一些也不想上传的文件，恰好输出到了 `dist` 中，那么可以增加一个参数 `uploadBlacklist`，例如：

```javascript
new ThunderPlugin({
  StarkOptions: {
    "projectName": "3d07127c",
    "dist": "dist",
    // 注意，虽然是字符串，但其实是作为正则表达式解析的，因为这个配置最终需要进行序列化
    uploadBlacklist: [
      'index\\.html',
      'favicon\\.ico',
    ],
  }
})
```

Stark 管理平台的地址为： http://diffadmin.sankuai.com/ 。上传完成之后，即可在管理平台上查看已经成功上传的文件列表。
