![](http://vfile.meituan.net/scarlett/48ecef7ad639d9a83e4cdcee70ca6eb633889.png)

![''](http://npm.sankuai.com/badge/v/@mtfe/thunder.svg)
[![Build Status](http://castle.sankuai.com/api/badge/zcm/fe-offlinify)](http://castle.sankuai.com/gh/zcm/fe-offlinify)

> 一个简单易用的渐进式 web 资源缓存与离线化方案

## 简介

`Thunder` 是一个渐进式资源缓存与离线化方案。它通过浏览器本地存储(localStorage/IndexedDB)缓存资源，并且基于 service-worker 提供了离线化能力。`Thunder` 的接入方式简单，不会侵入你的业务代码，仅需简单的配置，即可让你的 `Webpack` 项目享受高速资源加载。欢迎试用！

### 功能

- 渐进式 web 资源离线化: localStorage/IndexedDB 提供 JS 、CSS 离线化，ServiceWorker 全站离线化
- 增量更新：进一步利用缓存，降低资源版本更新成本
- 资源异常自动 CDN 降级: 提供页面资源加载稳定性 
- CDN 劫持自动降级: JS 内容检查校验和，不符合自动切换降级 CDN
- 极速页面加载性能: SDK gzip 后 8 KB, 结合离线化和增加更新，提升现代 web 应用加载体验
- 接入简单快捷：使用 webpack 插件即可接入，不侵入业务


### 环境要求

- [node](https://nodejs.org/en/): 6.x及以上
- [webpack](https://github.com/webpack/webpack): `2.x` `3.x` `4.x`
- chrome 18+ 

## 立即接入

### 项目场景

- [Era 项目](https://docs.sankuai.com/doc/zcm/fe-offlinify/qa/#era-thunder)
- [vue-cli 3.0](https://docs.sankuai.com/doc/zcm/fe-offlinify/#vue-cli-30-thunder)
- [webpack 纯静态](https://docs.sankuai.com/doc/zcm/fe-offlinify/#thunder)
- [nuxt](https://docs.sankuai.com/doc/zcm/fe-offlinify/qa/#nuxt-thunder)

### 安装

推荐使用 mnpm 安装：

```bash
mnpm i @mtfe/thunder -S
```

`@mtfe/thunder` 主要包含两个功能模块：

- webpack plugin
    - 收集依赖模块资源配置信息 `thunder-state.json`
    - 在 HTML 模板中注入 thunder SDK 以及依赖的资源配置信息
- node server helper
    - 提供静态资源 CSS、JS SDK 注入
    - 提供注入相关配置的 service worker 文件


### 引入 Thunder webpack 插件

接入 `Thunder` 并不复杂，你仅需在 `Webpack` 的配置文件中引入以下代码：

>由于 `Thunder` 的缓存机制，建议在非开发环境的构建中启用 Thunder，如果你的项目中使用了 HtmlWebpackPlugin，可以去掉它，因为 Thunder 也可以进静态资源的注入

```javascript
//webpack.conf.prod.js
const Thunder = require("@mtfe/thunder/plugin")
...
module.exports = {
    ...
    plugins:[
        ...
        new Thunder({
            //项目名称
            project: "example",

            ...

        }),
        ...
    ],
    ...
}
```

## 接入方式

### 在纯静态项目中使用 Thunder

```javascript
//webpack.conf.prod.js
const Thunder = require("@mtfe/thunder/plugin")
...
module.exports = {
    ...
    plugins:[
        ...
        new Thunder({
            // 项目名称 必填
            project: "example",
            fallbackCDN: 'https://cdn.com/path/to/',
            //模板注入配置
            injectHTML: {
                // 开发模板的绝对路径
                template: path.resolve(__dirname, 'path/to/your/template/index.html'),
                chunks: ['manifest', 'vendor', 'app'],
                styles: ['manifest', 'vendor', 'app'],
                filename: '/pages/pageB.html'
            }
        }),
        ...
    ],
    ...
}
```

使用了以上配置后，默认情况下，`Thunder` 插件会将样式文件注入到 `head` 闭合标签之前（目前只支持link的方式引入样式），js 相关代码会内嵌到body闭合标签之前。当然如果你想自定义注入的位置，你可以在模板中使用我们能识别的注释来标记位置，如下面的栗子：

```html
<header>
  <title></title>
  <!--thunder-style-inject-->
</header>
<body>
  <div id="app"></div>

  <!--thunder-script-inject-->
</body>
```

如果你的项目是多模板的，请阅读[如何配置多模板的项目](#multiTpl)。

### Vue cli 3.0 工程接入 Thunder

> Vue cli 3.0 将 HTMLWebpackPlugin 进行了内置，由于 Thunder 的缓存加载资源的方式，不再需要 HTMLWebpackPlugin 注入静态资源标签，所以需要对 HTMLWebpackPlugin 及其内置相关依赖它的插件进行排除。

```javascript
configureWebpack: config => {
    const removeList = [
    'HtmlWebpackPlugin',
    'InlineSourcePlugin',
    'PreloadPlugin',
    'CorsPlugin'
    ]
    for (let i = 0; i < config.plugins.length; ++i) {
      if (removeList.indexOf(config.plugins[i].constructor.name) !== -1) {
        delete config.plugins[i]
      }
    }
    config.plugins = config.plugins.filter(p => !!p)
}
```

使用 webpackChain api 加入 thunder plugin

```javascript
chainWebpack: (config) => {
    config
        .plugin('thunder')
        .use(ThunderPlugin, [
        {
          project: 'i-zhenguo-wanghong',
          injectHTML: {
            template: path.resolve(__dirname, './public/index.html'),
            filename: 'index.html',
            chunks: ['manifest', 'vendor', 'app'],
            styles: ['manifest', 'vendor', 'app'],
          }
        }
      ])
      .end()
  }
```

### 在 Koa / Express 中使用 Thunder

鉴于现在许多项目中使用 node 作为中间层，针对这样的场景，Thunder 提供了 thunderInjector，这样可以更灵活地接入 Thunder，实现页面静态注入和service worker 输出。

这里会用到上面小节提到的 `thunder-state.json`

```javascript
//server.js
const thunderState = require('path/to/thunder-state.json')

const thunderInjector = require('@mtfe/thunder/server/injector')({
    // 也可以通过path的方式引用thunder-state.json
    // path: 'path/to/thunder-state.json'
    thunderState: thunderState,
    
    // chunks需要严格按照wepack运行时的依赖关系
    chunks: ['manifest', 'vendor', 'app'],
    
    // 模板内置SDK以及启动代码，默认为true
    inline: true
})

app.get('index', function(req, res, next){
    res.render("index.ejs", {
        //样式代码
        styleContent: thunderInjector.getStylesContent(),
        //sdk以及加载启动脚本
        scriptContent: thunderInjector.getScriptsContent()
    })
})
```

在模板中你就能直接通过模板变量的方式来注入相关代码了，栗子如下：

```html
<!---index.ejs-->

<!DOCTYPE html>
<html lang="zh_CN">
    <head>
        <meta charset="utf-8">
        <title>test</title>

        <%- styleContent %>
    </head>
    <body>
        <div id="app"></div>
        <%- scriptContent %>
    </body>
</html>
```

## 深入说明

## Thunder 的 JS 资源加载方式

`thunder` 加载 JS 有两种方式：

- 同步：有 localStorage 缓存 缓存，同步从缓存中读取，最后执行
- 异步：IndexedDB 模式或没有 LS 缓存，或者是较老版本，异步请求更新补丁或者全量文件，最后执行
 
所以需要做在模块加载执行完成后与其他 sdk 交互执行相关操作，需要在 `console.log('all chunks loaded')` 相应的位置调用。

```
;(function (global) {
    var thunder = global.__thunder__
    thunder.parallel(['manifest', 'vendor', 'app'])
        .then(function () {
            console.log('all chunks loaded')
        })
})(window)
```

关于更多的资源加载原理请阅读[JS loader 机制](http://docs.sankuai.com/doc/zcm/fe-offlinify/depth/loader/)。

### 异步加载模块处理

当应用打包体积越来越大时，我们通常会考虑利用 webpack 提供的打包异步模块的能力，把一些不需要首屏展现的资源改为异步按需加载。

不用担心 thunder 无缝支持 webpack 异步模块异步加载：

```
// 同步引入
import { add } from '../lib.js'

add(1, 2)


// 在 webpack 中使用异步模块加载
import('../lib.js')
    .then({ add } => {
            add(1, 2)
        })
```

### 启用资源增量更新

有些时候我们的项目变动很少，但是用户更新资源的时候需要全部更新，对于那些非变动的部分更新是一种浪费，在弱网环境下，更新也会非常慢。针对这种情况，thunder结合stark资源托管系统提供的增量更新，在资源变动时，只对更改的部分进行更新替换，同时极大地提高弱网下资源更新速度。

更多的 `Stark 增量更新` 细节请阅读[Stark 增量更新配置](http://docs.sankuai.com/doc/zcm/fe-offlinify/depth/stark/#stark)。

### 启用 Service Worker

service worker 更多的配置细节请阅读[ServiceWorker 配置](http://docs.sankuai.com/doc/zcm/fe-offlinify/depth/sw/)。

## <span id="multiTpl">如何配置多模板的项目</span>

### 纯静态项目

对于多模板的项目，请参考以下的配置：

```javascript
const webpackConfig = {

  plugins: [
    ...
    new ThunderPlugin({
      project: 'example',
      injectHTML: [{
        chunks: ['manifest', 'vendor', 'pageA-entry'],
        template: path.resolve(__dirname, 'path/to/your/template/pageA.html'),
        filename: 'pages/index.html'
      }, {
        chunks: ['manifest', 'vendor', 'pageB-entry'],
        template: path.resolve(__dirname, 'path/to/your/template/pageB.html'),
        // 或者可以直接使用绝对路径
        filename: path.resolve(__dirname, 'path/to/your/pages/pageB.html')
      }]
    })
    ...
  ]
  ...
}
```

### Koa/Express

对于 node server 的配置可以参考下面的配置：

```javascript
//server.js
const thunderState = require('path/to/thunder-state.json')

const thunderInjectorA = require('@mtfe/thunder/server/injector')({
    //也可以通过path的方式引用thunder-state.json
    //path: 'path/to/thunder-state.json'
    thunderState: thunderState,
    //chunks需要严格按照wepack运行时的依赖关系
    chunks: ['manifest', 'vendor', 'entryA']
})

const thunderInjectorB = require('@mtfe/thunder/server/injector')({
    //也可以通过path的方式引用thunder-state.json
    //path: 'path/to/thunder-state.json'
    thunderState: thunderState,
    //chunks需要严格按照wepack运行时的依赖关系
    chunks: ['manifest', 'vendor', 'entryB']
})

app.get('indexA', function(req, res, next){
    res.render("indexA.ejs", {
        //样式代码
        styleContent: thunderInjectorA.getStylesContent(),
        //sdk以及启动脚本
        scriptContent: thunderInjectorA.getScriptsContent()
    })
})

app.get('indexB', function(req, res, next){
    res.render("indexB.ejs", {
        //样式代码
        styleContent: thunderInjectorB.getStylesContent(),
        //sdk以及启动脚本
        scriptContent: thunderInjectorB.getScriptsContent()
    })
})
```

## 完整配置

### webpack plugin

```
new Thunder({
            // 项目名称 必填
            project: "example",
            
            // fallbackCDN 可选，如果配置了 Stark 增量更新，可自动加入 stark 的降级 CDN https://km.sankuai.com/page/62021499
            // 未开启 stark 增量更新，或是其他 CDN，可填写这里，使用自动降级切换 CDN 功能
            fallbackCDN: 'https://cdn.com/path/to/',

            // 全局缓存周期 单位秒（s）, 默认为 1 年
            // 外链资源可以设定单独的 cacheAge，优先使用资源上声明的缓存周期
            cacheAge: 3600 * 24 * 30,  // 缓存周期为 30 天
            
            // 外链资源, 请参考 优化建议-缓存 KNB Cat 灵犀 SDK 等外链资源
            resources: {
                js: {
                    cat: '//www.dpfile.com/app/owl/static/owl_1.5.19.js'
                }
            },

            // bootloader 异步加载 thunder SDK 的模式
            // bootloaderMode: 'tiny', 可选，默认 tiny (LS), idb

            //模板注入配置，纯静态项目需要使用，node 项目可以使用 injector 注入在模板引擎中。
            injectHTML: {
                // 开发模板的绝对路径
                template: path.resolve(__dirname, 'path/to/your/template/index.html'),
                // 也可以为函数，返回值为模板内容
                // template: () => {
                //   return ejs.renderFile(path.resolve(__dirname, 'path/to/your/template/index.ejs', { ... }))
                // }

                // disable: true // 不注入 thunder sdk, 只注入原始标签

                prefetch: true, // 可选，启用预加载
                
                // JS 资源加载
                // 注意这里的顺序需要符合模块加载执行依赖关系
                chunks: ['manifest', 'vendor', 'app'],

                // CSS 资源加载
                styles: ['manifest', 'vendor', 'app'],

                // filename 配置页面输出路径
                filename: path.resolve(__dirname, 'path/to/your/pages/pageB.html')
                // 或者可以为相对路径，输出到 webpack 静态文件地址
                // filename: '/pages/pageB.html'
                
                mode: 'tiny' // 可选，默认，使用 localStorage, 其他选项： idb、bootloader

                // 使用 IndexedDB
                // mode: 'idb'

                // 使用 Bootloader 模式 (beta)
                // mode: 'bootloader'
            }
        }),
```

### server injector

```
//server.js
const thunderState = require('path/to/thunder-state.json')

const thunderInjectorA = require('@mtfe/thunder/server/injector')({
    //也可以通过path的方式引用thunder-state.json
    //path: 'path/to/thunder-state.json'
    thunderState: thunderState,
    
    // 禁用 thunder，可用于灰度开关使用
    // disable: false
    
    // CSS 资源加载
    styles: ['manifest', 'vendor', 'app'],
    
    // JS 资源加载
    // 注意这里的顺序需要符合模块加载执行依赖关系
    chunks: ['manifest', 'vendor', 'app'],

    // 启用预加载
    prefetch: true,
})

app.get('indexA', function(req, res, next){
    res.render("indexA.ejs", {
        // 样式代码
        styleContent: thunderInjectorA.getStylesContent(),
        // sdk以及启动脚本
        scriptContent: thunderInjectorA.getScriptsContent()
    })
})
```


## 更多优化

推荐 [缓存 KNB Cat 灵犀 SDK 等外链资源](/depth/suggestion/#knb-cat-sdk)

推荐 [启用预加载](/depth/suggestion/)
