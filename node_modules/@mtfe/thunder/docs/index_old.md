![](http://vfile.meituan.net/scarlett/48ecef7ad639d9a83e4cdcee70ca6eb633889.png)

![''](http://npm.sankuai.com/badge/v/@mtfe/thunder.svg)

> 一个轻量简单易用的 web 资源离线化方案

# 功能

- JavaScript localStorage 缓存离线化
- 基于 service worker 页面、资源离线化
- 资源字符级更新

# 演示

[demo 地址](https://hilongjw.github.io/offlinify/simple/index.html#/b)

# 依赖

- [webpack](https://github.com/webpack/webpack) `2.x` `3.x` `4.x`


# 开始接入

如果你的项目在使用 `HtmlWebpackPlugin` , 请参考 [快速接入](http://docs.sankuai.com/doc/zcm/fe-offlinify/simple/), 十分钟完成接入。

## 第一步：安装 thunder 依赖

```bash

npm install @mtfe/thunder

```

## 第二步：配置 thunder webpack 插件

推荐在 `非开发环境` webpack 配置中引入 `Thunder`, 因为 `Thunder` 的缓存特性在开发中并不需要。

```javascript
// webpack.conf.production.js

const ThunderPlugin = require('@mtfe/thunder/plugin')

const webpackConfig = {

  plugins: [
    ...
    new ThunderPlugin()
  ]

  ...
}
```

## 第三步：配置页面模板

`thunder-state.json` 是 `thunder webpack 插件` 输出的 webpack 输出相关配置和模块数据，用于在浏览器端初始化加载器 `thunder`。

> `thunder-state.json` 是 ThunderPlugin 在 webpack 获取的所有相关 chunk 的 hash 数据以及 thunder 会用到的 webpack 相关配置，它会输出在 webpack 中配置的  `output.path` 目录下。如果需要调试开发，thunderPlugin 实例上同样也会有 `thunderState` 属性。


在这里使用字符模板用于演示，在真实场景中可以使用任何模板引擎

你可能需要先运行 webpack build 才能看到 `thunder-state.json` 

```bash
npm run build
```

```javascript

const thunderState = require('./static/thunder-state.json')

/* 
* @param {String} thunderClient  thunder 浏览器端代码 
* @return {String}: "<script> ... </script>"
*/
const thunderClient = require('./src/thunder/server')(thunderState).client

app.get('route-path/', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>thunder-test</title>
          </head>
          <body>
            <div id="app">
                <h1>loading</h1>
            </div>

            <!-- 接入 thunder 之前的模式 -->
            <script src="cdn.url/manifest.5chsbw63478gsc8gb2g38g.js"></script>
            <script src="cdn.url/vendor.7sd2763478gsc8gb2g38g.js"></script>
            <script src="cdn.url/app.7sd2763478gsc8gb2g38g.js"></script>

            <!-- 接入 thunder 的模式 -->
            
            <!--  thunder client 代码注入 -->
            ${ thunderClient }
            <!--  thunder client 初始化 -->
            <script>
                ;(function (global) {
                  thunderCore.ready(function (thunder) {
                    thunder.parallel(['manifest', 'vendor', 'app'])
                  })
                })(window)
            </script>

          </body>
        </html>
    `)
})

```

# 进阶

## 使用 service worker

### 添加 service worker


```javascript

const thunderState = require('./static/thunder-state.json')
const { serviceWorker } = require('./src/thunder/server')(thunderState)

app.get('route-path/service-worker.js', (req, res) => {
  res.set({
    'Content-Type': 'application/javascript; charset=UTF-8',
    'Service-Worker-Allowed': '/your-scope',
  })
  res.send(serviceWorker)
})

```


>Note: 因为在目前测试中发现微信，美团等 webview 中 [ServiceWorkerGlobalScope](https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerGlobalScope) 中 `navigator.userAgent`
可能不会和 `window.navigator.userAgent` 同步，通过 service-worker 处理的请求 header 中 userAgent 可能不是容器定义的，所以在 service-worker 中加入了自定义字段 `X-Thunder-User-Agent`, 建议 server 端优先使用 `X-Thunder-User-Agent`。


### ServiceWorker 配置

`excludes` `includes` `cacheAndRefresh` 用于构造 RegExp 的字符数组

> 注意：通过 service worker 缓存的资源不能是 `http` 下的资源，在 `https` 下加载 `http` 资源会引发 [Mixed Content](https://developer.mozilla.org/en-US/docs/Web/Security/Mixed_content) , 导致资源不能被正常加载。如果有不能避免的 http 内容引入，尝试在 `excludes` 中加入 `'^http:\\/\\/'`。

```javascript
{
  serviceWorker: {
    path: '/static/service-worker.js',
    scope: '/pay',

    // 需要预加载的资源
    preCacheItems: [
      '/home',
      'https://cdn.com/home.css'
    ],
    
    // 缓存数限制，默认 200
    maxEntries: 100,

    // 缓存的时效
    cacheMaxAgeSeconds: 10,
    
    // 需要使用 cacheAndRefresh 策略的资源
    cacheAndRefresh: ['\\.json'],
    
    // 排除不需要 sw 缓存的资源
    excludes: ['/api/', 'frep\\.meituan\\.net', '^http://'],

    // 需要 sw 缓存的资源
    includes: ['.*'],
    debug: true
  }
}
```

* cacheAndRefresh

cacheAndRefresh 是优先返回缓存中的资源，同时会向服务器请求该资源，如果 `Etag` 与缓存资源不匹配，可以获得 `thunder.serviceWorkerManager` 的通知。

```javascript
thunder.serviceWorkerManager.$on('refresh', function ({ url }) {
  console.log(url, 'is updated, try refresh page')
})
```

### ServiceWorker 相关问题

#### thunder 的 sw 有缓存回收和过期机制吗？是怎样的机制？

在 thunder 的有缓存回收机制。请求被缓存写入就会记录 `createdAt`, 如果当前时间和 `createdAt` 差超过 `cacheMaxAgeSeconds` 时间（秒）就会回收过期的缓存。
还有一项关键的配置 `maxEntries`（默认 200）, 在 cacheStorage 中，大量的资源被缓存会导致取出的耗时增加，所以会有缓存数量的限制，超过缓存数量的限制会进行 LRU 策略的回收。


#### 我能存储多少数据？

| 浏览器         | 限制          |
| ------------- |:-------------:| 
| Chrome        | 可用空间 <6%   |
| Firebox       | 可用空间 <10%  | 
| Safari        |  <50MB        |
| IE10          |  <250MB       |

#### 如何了解我的应用目前使用了多少存储空间？

在 Chrome 中，您可以使用 [Quota Management API](https://www.w3.org/TR/quota-api/) 查询目前使用的存储空间大小，以及应用可使用多少空间。更新的 [Storage Quota Estimate API](https://www.chromestatus.com/features/5630353511284736) [StorageManager](https://developer.mozilla.org/en-US/docs/Web/API/StorageManager) 尝试通过支持 Promise，让用户更容易了解源目前使用了多少配额。


#### 缓存逐出是如何工作的？


| 浏览器         | 限制          |
| ------------- |:-------------:| 
| Chrome        | 在 Chrome 耗尽空间后采用 LRU 策略   |
| Firebox       | 在整个磁盘已装满时采用 LRU 策略  | 
| Safari        | 无逐出       |
| IE10          | 无逐出    |


## 使用 diff 更新

### Stark 配置

Stark 相关配置，增加 `StarkOptions` 之后 thunder 会启用 Stark diff 更新功能。


webpack plugin 配置

```javascript
new ThunderPlugin({
  StarkOptions: {
    // 项目在 Stark 管理平台上对应的 id
    "projectName": "3d07127c",
    // webpack 编译出文件的所在目录
    "dist": "dist"
  }
})
```

注意，如果启用了 Stark ，那么 webpack 所产生的资源都会一并上传到 Stark 自己的 CDN 上。此时， webpack 的 `publicPath` 也需要更改，应写为 "https://s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:PROJECT_NAME/"。其中 `PROJECT_NAME` 需要替换为 Stark 管理平台中你自己项目对应的 id ，该 id 与 `StarkOptions` 中的 `projectName` 一致。

通常来说， webpack 的编译和上传 Stark 是分开的两个过程，通过 `thunder-stark-plugin-upload path/to/thunder-state.json` 会将资源上传至 Stark。

默认情况下， `dist` 目录下的文件都会上传到 Stark 中。为了避免上传一些明显不需要的文件，我们内置了一个黑名单，只要**文件全路径**命中了黑名单中的任意一条规则，那么这个文件就不会上传：

```javascript
[
  /\.git/,
  /node_modules/,
  /thunder-state/,
  /service-worker/,
  /\.DS_Store/,
  /\.log$/,
  /\.map$/,
];
```

如果项目还有一些也不想上传的文件，恰好输出到了 `dist` 中，那么可以增加一个参数 `uploadBlacklist`，例如：

```javascript
new ThunderPlugin({
  StarkOptions: {
    "projectName": "3d07127c",
    "dist": "dist",
    // 注意，虽然是字符串，但其实是作为正则表达式解析的，因为这个配置最终需要进行序列化
    uploadBlacklist: [
      'index\\.html',
      'favicon\\.ico',
    ],
  }
})
```

Stark 管理平台的地址为： http://diffadmin.sankuai.com/ 。上传完成之后，即可在管理平台上查看已经成功上传的文件列表。

浏览器端配置

```javascript
thunderCore.ready((thunder, Thunder) => {
  // 使用 starkPlugin
  Thunder.use(Thunder.starkPlugin)
  
  thunder.parallel(['vendor', 'app'])
})

```

### BSOptions

> 即将废弃

BS diff 相关配置， `BSOptions` 之后 thunder 会启用 bs diff 更新功能

```javascript
new ThunderPlugin({
  BSOptions: {
    address: 'http://s1.meituan.net/bsm/diff-min',
    fallback: 'https://static.meituan.net/bsm/js',
    projectName: 'zc/fe-thunder-dev-test',
    dist: 'dist',
    filename: 'static/js/[name].js',
    chunkFilename: 'static/js/[id].js'
  }
})
```

因为 BS 依赖 git commit id 进行版本管理，所以推荐使用 thunder BS auto commit 功能，通过设定环境变量 `THUNDER_BS_AUTO` 为 true 就可以开启在打包完成之后自动 commit 并写入 commit id 到 thunder state 后上传 BS。

package.json

```json

{
  "scripts": {
    "build": "cross-env NODE_ENV=production node build/build.js",
    "build:bs": "cross-env NODE_ENV=production THUNDER_BS_AUTO=true node build/build.js"

    // or
    "afterbuild": "node ./node_modules/@mtfe/thunder/plugin/bs-helper.js --t-bs path-to-your/thunder-state.json"
  }
}

```

## 弱网网络策略

### networkTactic

>开启/关闭 弱网网络策略

弱网环境来源：微信、支付宝 UA / Chrome NetworkInformation (61 + )

网络类型：

 * 2G
 * 3G
 * 4G
 * WIFI
 * UNKNOWN

弱网网络策略是为了在弱网环境 (2G) 优先使用本地存在的缓存。

使用缓存与否涉及到3个因素：

 * 缓存中的版本有可用模块
 * 缓存中的版本至最新版本中没有任何强制更新 `FLAG`
 * 缓存中的版本创建日期在 7 天以内


```javascript
new ThunderPlugin({
  networkTactic: true // default: false
})
```

环境变量 THUNDER_FORCE_UPDATE 设置为 true 时会标记当前 build 版本为 forceUpdate, 如果不设置则为不需要 forceUpdate 版本

```bash
# normal build
$ cross-env NODE_ENV=production webpack --progress --hide-modules

# mark force-update build
$ cross-env NODE_ENV=production THUNDER_FORCE_UPDATE=true webpack --progress --hide-modules

```

# 更多

### 详细 webpack plugin 配置项

这里是目前 `Thunder` 支持的所有配置选项，包括 异步 chunk 名称使用 HASH, 弱网策略, BS 字符级更新配置，serviceWorker 等, 相关详细配置请继续向下阅读或者搜索当前页面。


```javascript
// webpack.config.js

const ThunderPlugin = require('@mtfe/thunder/plugin')

module.exports = {
  ...

  plugins: [
    new ThunderPlugin({
      // 管理输出文件名
      output: {
        // 设置 false 即表示不输出该文件
        // state: false,
        state: 'thunder-state.json',
        // thunder sdk script 支持 [hash] 关键词
        thunder: 'thunder.[hash].js',
        serviceWorker: 'service-worker.js'
      },
      // 异步 chunk 名称
      pathNameHash: false,
      
      // 弱网策略
      networkTactic: true,
      
      // 项目名称
      project: 'simple',

      // Stark 相关配置
      StarkOptions: {
        "projectName": "3d07127a",
        "dist": "dist"
      },

      // BS 字符级更新配置
      BSOptions: {
         address: 'http://s1.meituan.net/bsm/diff-min',
         fallback: 'https://static.meituan.net/bsm/js',
         projectName: 'zc/fe-thunder-dev-test',
         dist: 'dist',
         filename: 'static/js/[name].js',
         chunkFilename: 'static/js/[id].js',
      },

      // serviceWorker 配置
      serviceWorker: {
        path: '/static/service-worker.js',
        scope: '/pay'
      }
    })
  ]

  ...
}
```

### 异步 chunk 名称

在 thunder 中除了具名 chunk (如常见的入口文件，vendor，manifest，magic comment 指定名称的chunk), 默认使用 chunk 第一个依赖模块的文件路径作为名称。

```javascript
// named chunk
app.c6e71f3f5c75987a373f.js

// path name chunk
src-views-PageB-vue.c6e71f3f5c75987a373f.js
```

`pathNameHash` 为 `true` 时，会将 chunk path-name 的转换为 MD5，长度默认为 16

```javascript
new ThunderPlugin({
  pathNameHash: true, // default: false
  pathNameHashLength: 20, // default: 16
  chunkNameResolver: (chunk : Chunk, compilation : Compilation) : String => {} // Function
})

```


## Thunder browser SDK API

### bundleLoader

`bundleLoader` 加载具名 chunk, 不推荐手动拼接 pathname 加载异步模块，对于异步模块请使用 webpack `import()`。 

```javascript
/*
* bundleLoader
* @param chunkId : String or Number
* @return Promise
*/
thunder.bundleLoader('app')

```

example:

```javascript

thunderCore.ready((thunder, Thunder) => {
  thunder.bundleLoader('vendor')
    .then(function () {
      return thunder.bundleLoader('app')
    })
})

```

### parallel

> 添加版本：0.5.7

`parallel` 相对于 `bundleLoader` 的区别在于，`parallel` 支持多个 chunk 并行加载，在加载完成之后顺序执行。

```javascript
/*
* bundleLoader
* @param chunkIds : Array<String>
* @return Promise
*/
thunder.parallel(['manifest', 'vendor', 'app'])

```

example:

```javascript

thunderCore.ready((thunder, Thunder) => {
  thunder.parallel(['manifest', 'vendor', 'app'])
    .then(() => {
      console.log('manifest, vendor, app 3 chunks all loaded')
    })
})

```


### logger

thunder 支持多个打点方式

- perf

```html
<script>
    ;(function (global) {
      thunderCore.link = '/static/thunder.js'
      thunderCore.ready((thunder) => {
        thunder.logger.set(mta);
        thunder.bundleLoader('vendor')
          .then(() => {
             return thunder.bundleLoader('app')
          })
      })
    })(window)
</script>
```

- cat

```html
 <script>
    ;(function (global) {
      var thunderState = ${JSON.stringify(thunderState)};
      var thunder = new Thunder(thunderState);

      thunder.logger.use(thunder.logger.owl)
      
      thunder.bundleLoader('vendor')
        .then(() => {
           return thunder.bundleLoader('app')
        })

      global.__thunder__ = thunder;
    })(window)
</script>
```

- 自定义

```html
 <script>
    ;(function (global) {
      var thunderState = ${JSON.stringify(thunderState)};
      var thunder = new Thunder(thunderState);

      thunder.logger.use((data) => {
        console.log(data)
      })
      
      thunder.bundleLoader('vendor')
        .then(() => {
           return thunder.bundleLoader('app')
        })

      global.__thunder__ = thunder;
    })(window)
</script>
```

## serviceWorkerMananger


### cache.keys : Method
```
__thunder__.serviceWorkerManager.cache.keys()
  .then(result => {
    result // 为被 serviceWorker cache 的 url
  })
```

### cache.add : Method
```
__thunder__.serviceWorkerManager.cache.add('https://some.domain.com/file.ext')
  .then(result => {
    result // 已经加入 serviceWorker cache
  })
```

### cache.delete : Method
```
__thunder__.serviceWorkerManager.cache.delete('https://some.domain.com/file.ext')
  .then(result => {
    result // 已经从当前 serviceWorker cache 中清除
  })
```

### cache.clear : Method
```
__thunder__.serviceWorkerManager.cache.clear('https://some.domain.com/file.ext')
  .then(result => {
    result // 当前 serviceWorker cache 已经全部清理
  })
```

## Store

`store` 是 `thunder` 的缓存管理模块，它负责读写 localStorage 管理模块的缓存

```javascript
__thunder__.store
```

### store.remove

清除指定模块的 LS 缓存 

```javascript
/*
* remove
* @param chunkId : String or Number
*/
__thunder__.store.remove('app')

```

example:

```javascript

__thunder__.store.remove('app')

```

### store.clear

清除所有 Thunder 管理的缓存

```javascript
__thunder__.store.clear()

```

example:

```javascript

__thunder__.store.clear()

```

### store.stats

输出当前所有 Thunder 管理的缓存

```javascript
__thunder__.store.stats()

```

example:

```javascript

__thunder__.store.stats()

// output

[
  {
    "chunk": "vendor",
    "size": 33,
    "hash": "ef2377beec56484e7612",
    "loadedAt": "2017-11-06T03:49:36.055Z"
  },
  {
    "chunk": "app",
    "size": 838,
    "hash": "ef2377beec56484e7612",
    "loadedAt": "2017-11-06T03:49:36.079Z"
  },
  {
    "chunk": "src-App-vue",
    "size": 1028,
    "hash": "66900de342bfe3102a4d",
    "loadedAt": "2017-11-06T03:49:36.211Z"
  },
  {
    "chunk": "src-views-PageA-vue",
    "size": 12,
    "hash": "61e642ccb9033656d974",
    "loadedAt": "2017-11-06T03:49:36.321Z"
  },
  {
    "chunk": "src-services-ServiceUnknown-js",
    "size": 1,
    "hash": "5b2c7f069722ad3f35c6",
    "loadedAt": "2017-11-06T03:49:36.329Z"
  }
]
```


# Authors && Contributors

[longjiawen@meituan.com]

[duanbingyang@meituan.com]

[liuyanghe02@meituan.com]
