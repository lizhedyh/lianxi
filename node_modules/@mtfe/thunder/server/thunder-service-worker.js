const fs = require('fs')
const path = require('path')

let content = ''
const THUNDER_HASH_REG = /\[thunder-sw-hash\]/
const THUNDER_SCOPE_REG = /\[thunder-sw-scope\]/
const THUNDER_SW_OPTIONS_REG = /__THUNDER_STATE__SW__/

function getScript (thunderState, forceUpdate) {
  if (!forceUpdate && content) return content
  try {
    content = fs.readFileSync(path.resolve(__dirname, '../dist/service-worker.js'), 'utf-8')
    content = content.replace(THUNDER_HASH_REG, thunderState.compilation.hash)
    if (thunderState.serviceWorker) {
      content = content.replace(THUNDER_SW_OPTIONS_REG, Buffer.from(JSON.stringify(thunderState)).toString('base64'))
      content = content.replace(THUNDER_SCOPE_REG, thunderState.serviceWorker.scope)
    }
  } catch (e) {
    console.error('failed at thunder read service-worker', e)
  }
  return content
}

module.exports = getScript
